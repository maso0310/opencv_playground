{% extends "base.html" %}

{% block title %}植生指標實作 - OpenCV 教學平台{% endblock %}

{% block extra_head %}
<style>
    .step-container {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 4px solid #dee2e6;
        transition: all 0.3s;
    }
    .step-container.active {
        border-left-color: #198754;
        background: #f0fff4;
    }
    .step-container.completed {
        border-left-color: #0dcaf0;
        background: #e8f7fc;
    }
    .step-header {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin-bottom: 10px;
    }
    .step-number {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #dee2e6;
        color: #495057;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 15px;
        transition: all 0.3s;
    }
    .step-container.active .step-number {
        background: #198754;
        color: white;
    }
    .step-container.completed .step-number {
        background: #0dcaf0;
        color: white;
    }
    .step-title {
        font-weight: bold;
        font-size: 1.1rem;
        flex: 1;
    }
    .step-content {
        display: none;
        padding-left: 51px;
    }
    .step-container.active .step-content,
    .step-container.completed .step-content {
        display: block;
    }
    .step-result {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
    }
    .result-image {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .channel-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
    }
    .channel-box {
        text-align: center;
    }
    .channel-box img {
        width: 100%;
        border-radius: 4px;
    }
    .channel-label {
        font-weight: bold;
        margin-top: 5px;
        font-size: 0.9rem;
    }
    .code-block {
        background: #2d3748;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-family: 'Consolas', monospace;
        font-size: 0.85rem;
        overflow-x: auto;
        white-space: pre-wrap;
        margin-top: 10px;
    }
    .stats-box {
        background: #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .stat-item {
        background: white;
        padding: 10px;
        border-radius: 6px;
        text-align: center;
    }
    .stat-value {
        font-size: 1.3rem;
        font-weight: bold;
        color: #198754;
    }
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
    }
    .vi-selector {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .vi-btn {
        background: rgba(255,255,255,0.2);
        border: 2px solid rgba(255,255,255,0.3);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        margin: 5px;
    }
    .vi-btn:hover {
        background: rgba(255,255,255,0.3);
    }
    .vi-btn.active {
        background: white;
        color: #198754;
        border-color: white;
    }
    .upload-zone {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        margin-bottom: 20px;
    }
    .upload-zone:hover {
        border-color: #198754;
        background: #f0fff4;
    }
    .upload-zone.has-image {
        border-style: solid;
        border-color: #198754;
        padding: 15px;
    }
    .upload-zone.has-image img {
        max-height: 200px;
        border-radius: 8px;
    }
    .run-btn {
        width: 100%;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: bold;
    }
    .progress-bar-container {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    .progress-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #198754, #20c997);
        transition: width 0.5s;
    }
    .histogram-container {
        text-align: center;
    }
    .histogram-container img {
        max-width: 100%;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .final-result {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }
    .result-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .result-card h6 {
        margin-bottom: 10px;
        color: #495057;
    }
    .result-card img {
        width: 100%;
        border-radius: 6px;
    }
    .sidebar-info {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
    }
    .sidebar-info h6 {
        color: #856404;
        margin-bottom: 10px;
    }
    .formula-box {
        background: #2d3748;
        color: #68d391;
        font-family: 'Consolas', monospace;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 1.1rem;
        text-align: center;
        margin: 10px 0;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }
    .loading-overlay.show {
        display: flex;
    }
    .loading-box {
        background: white;
        padding: 30px 50px;
        border-radius: 10px;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- 左側：步驟區 -->
        <div class="col-lg-8">
            <h2 class="mb-4">
                <span class="text-success">植生指標</span> 分步驟實作
            </h2>

            <!-- 上傳區 -->
            <div class="upload-zone" id="uploadZone">
                <div id="uploadPrompt">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-success mb-3" viewBox="0 0 16 16">
                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                    </svg>
                    <h5>上傳植物圖片</h5>
                    <p class="text-muted mb-0">點擊或拖曳圖片到此處</p>
                </div>
                <div id="uploadPreview" style="display: none;">
                    <img id="previewImage" src="" alt="預覽">
                    <p class="text-success mt-2 mb-0"><strong>圖片已上傳</strong> - 點擊可更換</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
            </div>

            <!-- 進度條 -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBar" style="width: 0%"></div>
            </div>

            <!-- 步驟區 -->
            <div id="stepsContainer">
                <!-- 步驟 1: 通道拆解 -->
                <div class="step-container" data-step="1">
                    <div class="step-header" onclick="toggleStep(1)">
                        <div class="step-number">1</div>
                        <div class="step-title">通道拆解</div>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); runStep(1)">執行</button>
                    </div>
                    <div class="step-content">
                        <p class="text-muted">將 BGR 彩色影像拆解為藍(B)、綠(G)、紅(R) 三個獨立通道</p>
                        <div class="step-result" id="step1Result"></div>
                    </div>
                </div>

                <!-- 步驟 2: 正規化 -->
                <div class="step-container" data-step="2">
                    <div class="step-header" onclick="toggleStep(2)">
                        <div class="step-number">2</div>
                        <div class="step-title">正規化</div>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); runStep(2)">執行</button>
                    </div>
                    <div class="step-content">
                        <p class="text-muted">將像素值從 0-255 正規化到 0-1 範圍，方便數學運算</p>
                        <div class="step-result" id="step2Result"></div>
                    </div>
                </div>

                <!-- 步驟 3: 計算植生指標 -->
                <div class="step-container" data-step="3">
                    <div class="step-header" onclick="toggleStep(3)">
                        <div class="step-number">3</div>
                        <div class="step-title">計算植生指標</div>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); runStep(3)">執行</button>
                    </div>
                    <div class="step-content">
                        <p class="text-muted">根據選擇的指標公式計算每個像素的植生指標值</p>
                        <div class="step-result" id="step3Result"></div>
                    </div>
                </div>

                <!-- 步驟 4: Otsu 閾值計算 -->
                <div class="step-container" data-step="4">
                    <div class="step-header" onclick="toggleStep(4)">
                        <div class="step-number">4</div>
                        <div class="step-title">Otsu 閾值計算</div>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); runStep(4)">執行</button>
                    </div>
                    <div class="step-content">
                        <p class="text-muted">使用 Otsu 方法自動計算最佳二值化閾值</p>
                        <div class="step-result" id="step4Result"></div>
                    </div>
                </div>

                <!-- 步驟 5: 產生二值化遮罩 -->
                <div class="step-container" data-step="5">
                    <div class="step-header" onclick="toggleStep(5)">
                        <div class="step-number">5</div>
                        <div class="step-title">產生二值化遮罩</div>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); runStep(5)">執行</button>
                    </div>
                    <div class="step-content">
                        <p class="text-muted">根據閾值將圖片轉換為黑白遮罩（白色=植被）</p>
                        <div class="step-result" id="step5Result"></div>
                    </div>
                </div>

                <!-- 步驟 6: 遮罩切割 -->
                <div class="step-container" data-step="6">
                    <div class="step-header" onclick="toggleStep(6)">
                        <div class="step-number">6</div>
                        <div class="step-title">遮罩切割</div>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); runStep(6)">執行</button>
                    </div>
                    <div class="step-content">
                        <p class="text-muted">使用遮罩提取植被區域，背景設為黑色</p>
                        <div class="step-result" id="step6Result"></div>
                    </div>
                </div>

                <!-- 步驟 7: 直方圖 -->
                <div class="step-container" data-step="7">
                    <div class="step-header" onclick="toggleStep(7)">
                        <div class="step-number">7</div>
                        <div class="step-title">產生直方圖</div>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); runStep(7)">執行</button>
                    </div>
                    <div class="step-content">
                        <p class="text-muted">繪製植生指標數值分布的直方圖</p>
                        <div class="step-result" id="step7Result"></div>
                    </div>
                </div>
            </div>

            <!-- 一次執行全部 -->
            <div class="mt-4">
                <button class="btn btn-success run-btn" id="runAllBtn" onclick="runAllSteps()">
                    一次執行全部步驟
                </button>
            </div>
        </div>

        <!-- 右側：設定與資訊 -->
        <div class="col-lg-4">
            <!-- 植生指標選擇 -->
            <div class="vi-selector">
                <h5 class="mb-3">選擇植生指標</h5>
                <div class="d-flex flex-wrap">
                    {% for vi_id, vi_info in vi_indices.items() %}
                    <button class="vi-btn {% if loop.first %}active{% endif %}"
                            data-vi="{{ vi_id }}"
                            onclick="selectVI('{{ vi_id }}')">
                        {{ vi_id }}
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- 公式資訊 -->
            <div class="sidebar-info">
                <h6 id="viName">ExG (Excess Green)</h6>
                <div class="formula-box" id="viFormula">2G - R - B</div>
                <p class="mb-0 small" id="viDescription">最常用的植生指標，強調綠色區域。數值越高表示越可能是植被。</p>
            </div>

            <!-- 目前程式碼 -->
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <span>目前步驟程式碼</span>
                    <button class="btn btn-sm btn-outline-light" onclick="copyCode()">複製</button>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    <pre class="m-0"><code id="codeBlock" class="python"># 選擇步驟後顯示程式碼</code></pre>
                </div>
            </div>

            <!-- 統計資訊 -->
            <div class="card mt-3" id="statsCard" style="display: none;">
                <div class="card-header bg-success text-white">
                    統計資訊
                </div>
                <div class="card-body">
                    <div class="stats-grid" id="statsContent"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-box">
        <div class="spinner-border text-success mb-3" role="status"></div>
        <p class="mb-0" id="loadingText">處理中...</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 狀態變數
let currentFilename = null;
let currentVI = 'ExG';
let completedSteps = new Set();
let viData = {{ vi_indices | tojson }};

// DOM 元素
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const uploadPrompt = document.getElementById('uploadPrompt');
const uploadPreview = document.getElementById('uploadPreview');
const previewImage = document.getElementById('previewImage');
const progressBar = document.getElementById('progressBar');
const codeBlock = document.getElementById('codeBlock');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');

// 上傳功能
uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.style.borderColor = '#198754';
    uploadZone.style.background = '#f0fff4';
});

uploadZone.addEventListener('dragleave', () => {
    if (!currentFilename) {
        uploadZone.style.borderColor = '#ccc';
        uploadZone.style.background = '';
    }
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    if (e.dataTransfer.files.length > 0) {
        uploadFile(e.dataTransfer.files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        uploadFile(e.target.files[0]);
    }
});

async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    showLoading('上傳中...');

    try {
        const response = await fetch('{{ url_for("upload") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            currentFilename = data.filename;
            previewImage.src = data.url;
            uploadPrompt.style.display = 'none';
            uploadPreview.style.display = 'block';
            uploadZone.classList.add('has-image');

            // 重置步驟
            resetSteps();
        } else {
            alert(data.error || '上傳失敗');
        }
    } catch (error) {
        alert('上傳失敗: ' + error.message);
    } finally {
        hideLoading();
    }
}

// 選擇植生指標
function selectVI(vi) {
    currentVI = vi;

    // 更新按鈕狀態
    document.querySelectorAll('.vi-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.vi === vi);
    });

    // 更新資訊
    const info = viData[vi];
    if (info) {
        document.getElementById('viName').textContent = info.name;
        document.getElementById('viFormula').textContent = info.formula;
        document.getElementById('viDescription').textContent = info.description;
    }

    // 如果已經有圖片，重置步驟
    if (currentFilename) {
        resetSteps();
    }
}

// 切換步驟顯示
function toggleStep(step) {
    const container = document.querySelector(`.step-container[data-step="${step}"]`);
    if (container.classList.contains('active') || container.classList.contains('completed')) {
        // 不需要任何動作
    }
}

// 執行單一步驟
async function runStep(step) {
    if (!currentFilename) {
        alert('請先上傳圖片');
        return;
    }

    showLoading(`執行步驟 ${step}...`);

    try {
        const response = await fetch('{{ url_for("process_vi_step_route") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                filename: currentFilename,
                vi_type: currentVI,
                step: step
            })
        });

        const data = await response.json();

        if (data.success) {
            renderStepResult(step, data);
            completedSteps.add(step);
            updateProgress();
            updateStepStatus(step);
        } else {
            alert(data.error || '處理失敗');
        }
    } catch (error) {
        alert('處理失敗: ' + error.message);
    } finally {
        hideLoading();
    }
}

// 渲染步驟結果
function renderStepResult(step, data) {
    const resultDiv = document.getElementById(`step${step}Result`);

    let html = '';

    if (step === 1) {
        // 通道拆解
        html = `
            <div class="channel-grid">
                <div class="channel-box">
                    <img src="data:image/png;base64,${data.B_channel}" alt="B通道">
                    <div class="channel-label text-primary">B (藍)</div>
                </div>
                <div class="channel-box">
                    <img src="data:image/png;base64,${data.G_channel}" alt="G通道">
                    <div class="channel-label text-success">G (綠)</div>
                </div>
                <div class="channel-box">
                    <img src="data:image/png;base64,${data.R_channel}" alt="R通道">
                    <div class="channel-label text-danger">R (紅)</div>
                </div>
            </div>
        `;
    } else if (step === 2) {
        // 正規化
        html = `
            <div class="stats-box">
                <h6>正規化後統計</h6>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value text-primary">${data.stats.B.mean.toFixed(4)}</div>
                        <div class="stat-label">B 平均值</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value text-success">${data.stats.G.mean.toFixed(4)}</div>
                        <div class="stat-label">G 平均值</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value text-danger">${data.stats.R.mean.toFixed(4)}</div>
                        <div class="stat-label">R 平均值</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">0 ~ 1</div>
                        <div class="stat-label">數值範圍</div>
                    </div>
                </div>
            </div>
        `;
    } else if (step === 3) {
        // 植生指標計算
        html = `
            <div class="row">
                <div class="col-md-6">
                    <h6>灰階圖</h6>
                    <img class="result-image" src="data:image/png;base64,${data.vi_map}" alt="VI Map">
                </div>
                <div class="col-md-6">
                    <h6>熱力圖</h6>
                    <img class="result-image" src="data:image/png;base64,${data.vi_map_color}" alt="VI Color Map">
                </div>
            </div>
            <div class="stats-box mt-3">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${data.stats.min.toFixed(4)}</div>
                        <div class="stat-label">最小值</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.stats.max.toFixed(4)}</div>
                        <div class="stat-label">最大值</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.stats.mean.toFixed(4)}</div>
                        <div class="stat-label">平均值</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.stats.std.toFixed(4)}</div>
                        <div class="stat-label">標準差</div>
                    </div>
                </div>
            </div>
        `;
    } else if (step === 4) {
        // Otsu 閾值
        html = `
            <div class="text-center">
                <div class="stat-value" style="font-size: 3rem;">${data.threshold.toFixed(1)}</div>
                <div class="stat-label">Otsu 自動計算閾值</div>
            </div>
        `;
    } else if (step === 5) {
        // 二值化遮罩
        html = `
            <div class="text-center">
                <img class="result-image" src="data:image/png;base64,${data.mask}" alt="Mask" style="max-height: 300px;">
            </div>
            <div class="stats-box mt-3">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${data.pixel_count.vegetation.toLocaleString()}</div>
                        <div class="stat-label">植被像素</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${data.coverage.toFixed(2)}%</div>
                        <div class="stat-label">植被覆蓋率</div>
                    </div>
                </div>
            </div>
        `;
    } else if (step === 6) {
        // 遮罩切割
        html = `
            <div class="text-center">
                <img class="result-image" src="data:image/png;base64,${data.segmented}" alt="Segmented" style="max-height: 400px;">
                <p class="text-success mt-2"><strong>只保留植被區域，背景為黑色</strong></p>
            </div>
        `;
    } else if (step === 7) {
        // 直方圖
        html = `
            <div class="histogram-container">
                <img src="data:image/png;base64,${data.histogram}" alt="Histogram">
            </div>
        `;
    }

    resultDiv.innerHTML = html;

    // 更新程式碼
    if (data.code) {
        codeBlock.textContent = data.code;
        hljs.highlightElement(codeBlock);
    }
}

// 更新步驟狀態
function updateStepStatus(step) {
    const container = document.querySelector(`.step-container[data-step="${step}"]`);
    container.classList.add('completed');
    container.classList.remove('active');

    // 開啟下一步
    const nextStep = step + 1;
    if (nextStep <= 7) {
        const nextContainer = document.querySelector(`.step-container[data-step="${nextStep}"]`);
        nextContainer.classList.add('active');
    }
}

// 更新進度條
function updateProgress() {
    const progress = (completedSteps.size / 7) * 100;
    progressBar.style.width = `${progress}%`;
}

// 重置步驟
function resetSteps() {
    completedSteps.clear();
    progressBar.style.width = '0%';

    document.querySelectorAll('.step-container').forEach((container, index) => {
        container.classList.remove('active', 'completed');
        if (index === 0) container.classList.add('active');

        const resultDiv = container.querySelector('.step-result');
        if (resultDiv) resultDiv.innerHTML = '';
    });

    codeBlock.textContent = '# 選擇步驟後顯示程式碼';
    document.getElementById('statsCard').style.display = 'none';
}

// 執行全部步驟
async function runAllSteps() {
    if (!currentFilename) {
        alert('請先上傳圖片');
        return;
    }

    showLoading('執行全部步驟...');

    try {
        const response = await fetch('{{ url_for("process_vi_full_route") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                filename: currentFilename,
                vi_type: currentVI
            })
        });

        const data = await response.json();

        if (data.success) {
            // 標記所有步驟完成
            for (let i = 1; i <= 7; i++) {
                completedSteps.add(i);
                const container = document.querySelector(`.step-container[data-step="${i}"]`);
                container.classList.add('completed');
                container.classList.remove('active');
            }
            updateProgress();

            // 顯示最終結果
            renderFullResult(data);
        } else {
            alert(data.error || '處理失敗');
        }
    } catch (error) {
        alert('處理失敗: ' + error.message);
    } finally {
        hideLoading();
    }
}

// 渲染完整結果
function renderFullResult(data) {
    // 更新各步驟結果
    document.getElementById('step3Result').innerHTML = `
        <div class="row">
            <div class="col-6">
                <img class="result-image" src="data:image/png;base64,${data.vi_map}" alt="VI Map">
            </div>
            <div class="col-6">
                <img class="result-image" src="data:image/png;base64,${data.vi_map_color}" alt="VI Color Map">
            </div>
        </div>
    `;

    document.getElementById('step4Result').innerHTML = `
        <div class="text-center">
            <div class="stat-value" style="font-size: 2rem;">${data.threshold.toFixed(1)}</div>
            <div class="stat-label">Otsu 閾值</div>
        </div>
    `;

    document.getElementById('step5Result').innerHTML = `
        <div class="text-center">
            <img class="result-image" src="data:image/png;base64,${data.mask}" alt="Mask" style="max-height: 200px;">
        </div>
    `;

    document.getElementById('step6Result').innerHTML = `
        <div class="text-center">
            <img class="result-image" src="data:image/png;base64,${data.segmented}" alt="Result" style="max-height: 300px;">
        </div>
    `;

    document.getElementById('step7Result').innerHTML = `
        <div class="histogram-container">
            <img src="data:image/png;base64,${data.histogram}" alt="Histogram">
        </div>
    `;

    // 更新程式碼
    codeBlock.textContent = data.code;
    hljs.highlightElement(codeBlock);

    // 顯示統計資訊
    const statsCard = document.getElementById('statsCard');
    statsCard.style.display = 'block';
    document.getElementById('statsContent').innerHTML = `
        <div class="stat-item">
            <div class="stat-value">${data.stats.vi_mean.toFixed(4)}</div>
            <div class="stat-label">${currentVI} 平均值</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${data.stats.coverage.toFixed(2)}%</div>
            <div class="stat-label">植被覆蓋率</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${data.stats.vegetation_pixels.toLocaleString()}</div>
            <div class="stat-label">植被像素數</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${data.threshold.toFixed(1)}</div>
            <div class="stat-label">Otsu 閾值</div>
        </div>
    `;
}

// Loading 控制
function showLoading(text = '處理中...') {
    loadingText.textContent = text;
    loadingOverlay.classList.add('show');
}

function hideLoading() {
    loadingOverlay.classList.remove('show');
}

// 複製程式碼
function copyCode() {
    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
        alert('程式碼已複製!');
    });
}

// 初始化 highlight.js
hljs.highlightAll();

// 初始化第一個步驟為 active
document.querySelector('.step-container[data-step="1"]').classList.add('active');
</script>
{% endblock %}
