<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>程式實作區 - OpenCV 教學平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- CodeMirror -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2940;
            --bg-cell: #282a36;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent-green: #50fa7b;
            --accent-blue: #8be9fd;
            --accent-purple: #bd93f9;
            --accent-orange: #ffb86c;
            --accent-red: #ff5555;
            --accent-yellow: #f1fa8c;
            --border-color: #44475a;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: rgba(26, 26, 46, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--accent-green) !important;
        }

        .nav-link {
            color: var(--text-primary) !important;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent-green) !important;
        }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, rgba(80, 250, 123, 0.1), rgba(139, 233, 253, 0.1));
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .page-header h1 {
            color: var(--accent-green);
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* Notebook Area */
        .notebook-area {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .notebook-header {
            background: var(--bg-cell);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notebook-header h5 {
            margin: 0;
            color: var(--accent-purple);
        }

        .notebook-body {
            padding: 1rem;
        }

        /* Code Cell */
        .code-cell {
            background: var(--bg-cell);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .code-cell.running {
            border-color: var(--accent-orange);
        }

        .code-cell.success {
            border-color: var(--accent-green);
        }

        .code-cell.error {
            border-color: var(--accent-red);
        }

        .cell-header {
            background: rgba(68, 71, 90, 0.5);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .cell-number {
            font-family: monospace;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .cell-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .cell-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-run {
            background: var(--accent-green);
            color: #000;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-run:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(80, 250, 123, 0.3);
        }

        .btn-run:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .cell-editor {
            min-height: 100px;
        }

        /* CodeMirror Override */
        .CodeMirror {
            height: auto;
            min-height: 80px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            background: var(--bg-cell);
        }

        .CodeMirror-gutters {
            background: rgba(68, 71, 90, 0.3);
            border-right: 1px solid var(--border-color);
        }

        /* Cell Output */
        .cell-output {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            display: none;
        }

        .cell-output.show {
            display: block;
        }

        .output-label {
            font-size: 0.75rem;
            color: var(--accent-orange);
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .output-text {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .output-error {
            color: var(--accent-red);
            background: rgba(255, 85, 85, 0.1);
        }

        .output-images {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .output-image-item {
            text-align: center;
        }

        .output-image-item img {
            max-width: 250px;
            max-height: 200px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .output-image-label {
            font-size: 0.75rem;
            color: var(--accent-blue);
            margin-top: 0.25rem;
            font-family: monospace;
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .panel-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .panel-header {
            background: var(--bg-cell);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header h6 {
            margin: 0;
            color: var(--accent-blue);
            font-size: 0.9rem;
        }

        .panel-body {
            padding: 1rem;
        }

        /* Sample Image */
        .sample-image-container {
            text-align: center;
        }

        .sample-image-container img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .sample-image-info {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* Variables Panel */
        .variables-list {
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .var-item {
            padding: 0.35rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }

        .var-item:last-child {
            border-bottom: none;
        }

        .var-name {
            color: var(--accent-yellow);
        }

        .var-type {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* VI Reference */
        .vi-reference {
            font-size: 0.85rem;
        }

        .vi-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .vi-item:last-child {
            border-bottom: none;
        }

        .vi-name {
            font-weight: 600;
            color: var(--accent-green);
        }

        .vi-formula {
            font-family: monospace;
            color: var(--accent-purple);
            font-size: 0.8rem;
        }

        /* Toolbar Buttons */
        .toolbar-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-blue);
        }

        .toolbar-btn.danger:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* Instructions */
        .instructions-box {
            background: rgba(139, 233, 253, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
        }

        .instructions-box h6 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .instructions-box ol {
            margin: 0;
            padding-left: 1.25rem;
        }

        .instructions-box li {
            margin-bottom: 0.25rem;
        }

        /* Loading */
        .cell-loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-orange);
            font-size: 0.85rem;
        }

        .cell-loading.show {
            display: flex;
        }

        .spinner-sm {
            width: 16px;
            height: 16px;
            border: 2px solid var(--accent-orange);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-leaf me-2"></i>OpenCV 教學平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>首頁
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('playground') }}">
                            <i class="fas fa-flask me-1"></i>Playground
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('vi_lab') }}">
                            <i class="fas fa-code me-1"></i>程式實作區
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('submissions') }}">
                            <i class="fas fa-upload me-1"></i>作業繳交
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-terminal me-2"></i>程式實作區</h1>
                    <p class="text-secondary mb-0">撰寫 Python 程式碼，分階段執行植生指標計算</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="toolbar-btn" onclick="addCell()">
                        <i class="fas fa-plus me-1"></i>新增儲存格
                    </button>
                    <button class="toolbar-btn" onclick="runAllCells()">
                        <i class="fas fa-play me-1"></i>全部執行
                    </button>
                    <button class="toolbar-btn danger" onclick="resetSession()">
                        <i class="fas fa-redo me-1"></i>重置
                    </button>
                </div>
            </div>
        </div>

        <div class="main-container">
            <!-- Notebook Area -->
            <div class="notebook-area">
                <div class="notebook-header">
                    <h5><i class="fas fa-book-open me-2"></i>程式碼編輯區</h5>
                    <span class="text-secondary" style="font-size: 0.85rem;">
                        變數 <code>img</code> 已預先載入範例圖片
                    </span>
                </div>
                <div class="notebook-body" id="notebookBody">
                    <!-- Cells will be added here -->
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Sample Image -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-image me-2"></i>範例圖片 (img)</h6>
                    </div>
                    <div class="panel-body">
                        <div class="sample-image-container">
                            <img id="sampleImage" src="" alt="範例圖片">
                            <div class="sample-image-info" id="sampleImageInfo">載入中...</div>
                        </div>
                    </div>
                </div>

                <!-- Variables -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-database me-2"></i>目前變數</h6>
                    </div>
                    <div class="panel-body">
                        <div class="variables-list" id="variablesList">
                            <div class="text-secondary" style="font-size: 0.85rem;">尚未執行程式碼</div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-tasks me-2"></i>作業步驟</h6>
                    </div>
                    <div class="panel-body">
                        <div class="instructions-box">
                            <ol>
                                <li>通道分離 (cv2.split)</li>
                                <li>正規化計算 (r, g, b)</li>
                                <li>植生指標計算</li>
                                <li>Otsu 閾值 (cv2.threshold)</li>
                                <li>產生二值化遮罩</li>
                                <li>遮罩切圖 (cv2.bitwise_and)</li>
                                <li>產生直方圖 (matplotlib)</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- VI Reference -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-calculator me-2"></i>植生指標公式</h6>
                    </div>
                    <div class="panel-body">
                        <div class="vi-reference">
                            {% for vi_id, vi_info in vi_indices.items() %}
                            <div class="vi-item">
                                <div class="vi-name">{{ vi_info.name }}</div>
                                <div class="vi-formula">{{ vi_info.formula }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

    <script>
        // Session ID
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Cell counter
        let cellCounter = 0;
        const editors = {};

        // Default code templates
        const defaultCells = [
            {
                title: '步驟 1: 通道分離',
                code: `# 將 BGR 影像分離為三個通道
B, G, R = cv2.split(img)

print(f"影像形狀: {img.shape}")
print(f"R 通道形狀: {R.shape}, 資料類型: {R.dtype}")`
            },
            {
                title: '步驟 2: 正規化計算',
                code: `# 計算正規化的 r, g, b 值
# 轉換為 float 避免溢位
R_f = R.astype(np.float32)
G_f = G.astype(np.float32)
B_f = B.astype(np.float32)

# 計算總和 (避免除以零)
total = R_f + G_f + B_f + 1e-6

# 正規化
r = R_f / total
g = G_f / total
b = B_f / total

print(f"r 範圍: {r.min():.4f} ~ {r.max():.4f}")
print(f"g 範圍: {g.min():.4f} ~ {g.max():.4f}")
print(f"b 範圍: {b.min():.4f} ~ {b.max():.4f}")`
            },
            {
                title: '步驟 3: 植生指標計算',
                code: `# 計算 ExG (Excess Green) 植生指標
# 公式: ExG = 2g - r - b
ExG = 2 * g - r - b

print(f"ExG 範圍: {ExG.min():.4f} ~ {ExG.max():.4f}")
print(f"ExG 平均值: {ExG.mean():.4f}")`
            },
            {
                title: '步驟 4: 正規化至 0-255 並計算 Otsu 閾值',
                code: `# 將植生指標正規化到 0-255
vi_normalized = cv2.normalize(ExG, None, 0, 255, cv2.NORM_MINMAX)
vi_uint8 = vi_normalized.astype(np.uint8)

# 使用 Otsu 方法計算最佳閾值
threshold_value, mask = cv2.threshold(vi_uint8, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

print(f"Otsu 閾值: {threshold_value}")`
            },
            {
                title: '步驟 5: 使用遮罩切割原圖',
                code: `# 使用遮罩提取植物區域
result = cv2.bitwise_and(img, img, mask=mask)

# 計算植被覆蓋率
vegetation_pixels = np.sum(mask == 255)
total_pixels = mask.shape[0] * mask.shape[1]
coverage = (vegetation_pixels / total_pixels) * 100

print(f"植被覆蓋率: {coverage:.2f}%")`
            },
            {
                title: '步驟 6: 產生直方圖',
                code: `# 使用 matplotlib 產生直方圖
import matplotlib
matplotlib.use('Agg')  # 非互動模式
import matplotlib.pyplot as plt
import io
import base64

# 取得植被區域的 ExG 值
vegetation_values = ExG[mask == 255].flatten()

# 繪製直方圖
fig, ax = plt.subplots(figsize=(8, 5))
ax.hist(vegetation_values, bins=50, color='green', alpha=0.7, edgecolor='darkgreen')
ax.axvline(x=threshold_value/255, color='red', linestyle='--', linewidth=2, label=f'Otsu 閾值')
ax.set_xlabel('ExG 值', fontsize=12)
ax.set_ylabel('像素數量', fontsize=12)
ax.set_title(f'植被區域 ExG 分布 (覆蓋率: {coverage:.1f}%)', fontsize=14)
ax.legend()
ax.grid(True, alpha=0.3)

# 轉換為 base64
buf = io.BytesIO()
fig.savefig(buf, format='png', dpi=100, bbox_inches='tight')
buf.seek(0)
histogram_img = 'data:image/png;base64,' + base64.b64encode(buf.read()).decode('utf-8')
plt.close(fig)

print("直方圖已產生！")`
            }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleImage();

            // Add default cells
            defaultCells.forEach(cell => {
                addCell(cell.title, cell.code);
            });
        });

        // Load sample image
        function loadSampleImage() {
            fetch('{{ url_for("get_sample_image") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('sampleImage').src = data.image;
                        document.getElementById('sampleImageInfo').textContent =
                            `shape: (${data.shape.join(', ')})`;
                    } else {
                        document.getElementById('sampleImageInfo').textContent = '圖片載入失敗';
                    }
                })
                .catch(error => {
                    document.getElementById('sampleImageInfo').textContent = '圖片載入失敗';
                });
        }

        // Add new cell
        function addCell(title = '', code = '') {
            cellCounter++;
            const cellId = `cell_${cellCounter}`;

            const cellHtml = `
                <div class="code-cell" id="${cellId}">
                    <div class="cell-header">
                        <div>
                            <span class="cell-number">[${cellCounter}]</span>
                            <span class="cell-title">${title || '程式碼儲存格'}</span>
                        </div>
                        <div class="cell-actions">
                            <div class="cell-loading" id="${cellId}_loading">
                                <div class="spinner-sm"></div>
                                <span>執行中...</span>
                            </div>
                            <button class="btn-run" onclick="runCell('${cellId}')">
                                <i class="fas fa-play me-1"></i>執行
                            </button>
                            <button class="toolbar-btn" onclick="deleteCell('${cellId}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="cell-editor" id="${cellId}_editor"></div>
                    <div class="cell-output" id="${cellId}_output"></div>
                </div>
            `;

            document.getElementById('notebookBody').insertAdjacentHTML('beforeend', cellHtml);

            // Initialize CodeMirror
            const editor = CodeMirror(document.getElementById(`${cellId}_editor`), {
                value: code,
                mode: 'python',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: true,
                extraKeys: {
                    'Shift-Enter': function(cm) {
                        runCell(cellId);
                    },
                    'Tab': function(cm) {
                        cm.replaceSelection('    ', 'end');
                    }
                }
            });

            editors[cellId] = editor;
        }

        // Delete cell
        function deleteCell(cellId) {
            const cell = document.getElementById(cellId);
            if (cell && Object.keys(editors).length > 1) {
                cell.remove();
                delete editors[cellId];
            }
        }

        // Run cell
        async function runCell(cellId) {
            const editor = editors[cellId];
            const code = editor.getValue();
            const cell = document.getElementById(cellId);
            const loading = document.getElementById(`${cellId}_loading`);
            const output = document.getElementById(`${cellId}_output`);

            // Update UI
            cell.className = 'code-cell running';
            loading.classList.add('show');

            try {
                const response = await fetch('{{ url_for("execute_code") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        session_id: sessionId,
                        cell_id: cellId
                    })
                });

                const data = await response.json();

                // Show output
                output.classList.add('show');

                if (data.success) {
                    cell.className = 'code-cell success';

                    let outputHtml = '';

                    // Text output
                    if (data.output) {
                        outputHtml += `
                            <div class="output-label">Output:</div>
                            <div class="output-text">${escapeHtml(data.output)}</div>
                        `;
                    }

                    // Images
                    if (data.images && Object.keys(data.images).length > 0) {
                        outputHtml += '<div class="output-images">';
                        for (const [name, src] of Object.entries(data.images)) {
                            outputHtml += `
                                <div class="output-image-item">
                                    <img src="${src}" alt="${name}">
                                    <div class="output-image-label">${name}</div>
                                </div>
                            `;
                        }
                        outputHtml += '</div>';
                    }

                    output.innerHTML = outputHtml || '<div class="text-secondary">執行完成 (無輸出)</div>';

                    // Update variables panel
                    updateVariablesPanel(data.variables);

                } else {
                    cell.className = 'code-cell error';
                    output.innerHTML = `
                        <div class="output-label">Error:</div>
                        <div class="output-text output-error">${escapeHtml(data.error)}\n\n${escapeHtml(data.traceback || '')}</div>
                    `;
                }

            } catch (error) {
                cell.className = 'code-cell error';
                output.classList.add('show');
                output.innerHTML = `
                    <div class="output-label">Error:</div>
                    <div class="output-text output-error">網路錯誤: ${error.message}</div>
                `;
            } finally {
                loading.classList.remove('show');
            }
        }

        // Run all cells
        async function runAllCells() {
            for (const cellId of Object.keys(editors)) {
                await runCell(cellId);
            }
        }

        // Reset session
        async function resetSession() {
            if (!confirm('確定要重置嗎？所有變數將被清除。')) return;

            try {
                await fetch('{{ url_for("reset_session") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                // Clear all outputs
                document.querySelectorAll('.cell-output').forEach(el => {
                    el.classList.remove('show');
                    el.innerHTML = '';
                });

                document.querySelectorAll('.code-cell').forEach(el => {
                    el.className = 'code-cell';
                });

                // Clear variables panel
                document.getElementById('variablesList').innerHTML =
                    '<div class="text-secondary" style="font-size: 0.85rem;">尚未執行程式碼</div>';

            } catch (error) {
                alert('重置失敗: ' + error.message);
            }
        }

        // Update variables panel
        function updateVariablesPanel(variables) {
            const panel = document.getElementById('variablesList');

            if (!variables || Object.keys(variables).length === 0) {
                panel.innerHTML = '<div class="text-secondary" style="font-size: 0.85rem;">尚無變數</div>';
                return;
            }

            let html = '';
            for (const [name, info] of Object.entries(variables)) {
                html += `
                    <div class="var-item">
                        <span class="var-name">${name}</span>
                        <span class="var-type">${info}</span>
                    </div>
                `;
            }

            panel.innerHTML = html;
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
