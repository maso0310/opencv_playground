<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>程式實作區 - OpenCV 教學平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- CodeMirror -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #1f2940;
            --bg-cell: #282a36;
            --text-primary: #e8e8e8;
            --text-secondary: #a0a0a0;
            --accent-green: #50fa7b;
            --accent-blue: #8be9fd;
            --accent-purple: #bd93f9;
            --accent-orange: #ffb86c;
            --accent-red: #ff5555;
            --accent-yellow: #f1fa8c;
            --border-color: #44475a;
        }

        body {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: rgba(26, 26, 46, 0.95) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand {
            font-weight: 700;
            color: var(--accent-green) !important;
        }

        .nav-link {
            color: var(--text-primary) !important;
        }

        .nav-link:hover, .nav-link.active {
            color: var(--accent-green) !important;
        }

        /* Page Header */
        .page-header {
            background: linear-gradient(135deg, rgba(80, 250, 123, 0.1), rgba(139, 233, 253, 0.1));
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .page-header h1 {
            color: var(--accent-green);
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
        }

        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* Notebook Area */
        .notebook-area {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .notebook-header {
            background: var(--bg-cell);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notebook-header h5 {
            margin: 0;
            color: var(--accent-purple);
        }

        .notebook-body {
            padding: 1rem;
        }

        /* Code Cell */
        .code-cell {
            background: var(--bg-cell);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .code-cell.running {
            border-color: var(--accent-orange);
        }

        .code-cell.success {
            border-color: var(--accent-green);
        }

        .code-cell.error {
            border-color: var(--accent-red);
        }

        .cell-header {
            background: rgba(68, 71, 90, 0.5);
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .cell-number {
            font-family: monospace;
            color: var(--accent-blue);
            font-weight: 600;
        }

        .cell-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .cell-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-run {
            background: var(--accent-green);
            color: #000;
            border: none;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-run:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 10px rgba(80, 250, 123, 0.3);
        }

        .btn-run:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        .cell-editor {
            min-height: 100px;
        }

        /* CodeMirror Override */
        .CodeMirror {
            height: auto;
            min-height: 80px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            background: var(--bg-cell);
        }

        .CodeMirror-gutters {
            background: rgba(68, 71, 90, 0.3);
            border-right: 1px solid var(--border-color);
        }

        /* Cell Output */
        .cell-output {
            border-top: 1px solid var(--border-color);
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            display: none;
        }

        .cell-output.show {
            display: block;
        }

        .output-label {
            font-size: 0.75rem;
            color: var(--accent-orange);
            margin-bottom: 0.5rem;
            font-family: monospace;
        }

        .output-text {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-primary);
            white-space: pre-wrap;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
        }

        .output-error {
            color: var(--accent-red);
            background: rgba(255, 85, 85, 0.1);
        }

        .output-images {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .output-image-item {
            text-align: center;
        }

        .output-image-item img {
            max-width: 250px;
            max-height: 200px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .output-image-item img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .output-image-label {
            font-size: 0.75rem;
            color: var(--accent-blue);
            margin-top: 0.25rem;
            font-family: monospace;
        }

        /* Image Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            font-size: 2rem;
            color: white;
            cursor: pointer;
            transition: color 0.2s;
        }

        .image-modal-close:hover {
            color: var(--accent-red);
        }

        /* Upload Button */
        .btn-upload-custom {
            background: rgba(139, 233, 253, 0.2);
            border: 1px dashed var(--accent-blue);
            color: var(--accent-blue);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
            width: 100%;
            margin-top: 0.75rem;
        }

        .btn-upload-custom:hover {
            background: rgba(139, 233, 253, 0.3);
            border-style: solid;
        }

        /* Right Panel */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .panel-card {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .panel-header {
            background: var(--bg-cell);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header h6 {
            margin: 0;
            color: var(--accent-blue);
            font-size: 0.9rem;
        }

        .panel-body {
            padding: 1rem;
        }

        /* Sample Image */
        .sample-image-container {
            text-align: center;
        }

        .sample-image-container img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .sample-image-info {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: monospace;
        }

        /* Variables Panel */
        .variables-list {
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 200px;
            overflow-y: auto;
        }

        .var-item {
            padding: 0.35rem 0;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
        }

        .var-item:last-child {
            border-bottom: none;
        }

        .var-name {
            color: var(--accent-yellow);
        }

        .var-type {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        /* VI Reference */
        .vi-reference {
            font-size: 0.85rem;
        }

        .vi-item {
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .vi-item:last-child {
            border-bottom: none;
        }

        .vi-name {
            font-weight: 600;
            color: var(--accent-green);
        }

        .vi-formula {
            font-family: monospace;
            color: var(--accent-purple);
            font-size: 0.8rem;
        }

        /* Toolbar Buttons */
        .toolbar-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.35rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-blue);
        }

        .toolbar-btn.danger:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* Instructions */
        .instructions-box {
            background: rgba(139, 233, 253, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
        }

        .instructions-box h6 {
            color: var(--accent-blue);
            margin-bottom: 0.5rem;
        }

        .instructions-box ol {
            margin: 0;
            padding-left: 1.25rem;
        }

        .instructions-box li {
            margin-bottom: 0.25rem;
        }

        /* Loading */
        .cell-loading {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--accent-orange);
            font-size: 0.85rem;
        }

        .cell-loading.show {
            display: flex;
        }

        .spinner-sm {
            width: 16px;
            height: 16px;
            border: 2px solid var(--accent-orange);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Info Button */
        .btn-info-cell {
            background: rgba(189, 147, 249, 0.2);
            border: 1px solid var(--accent-purple);
            color: var(--accent-purple);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-info-cell:hover {
            background: rgba(189, 147, 249, 0.4);
            transform: scale(1.05);
        }

        /* Info Modal */
        .info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9998;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .info-modal.show {
            display: flex;
        }

        .info-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            max-width: 700px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .info-modal-header {
            background: var(--bg-cell);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .info-modal-header h4 {
            margin: 0;
            color: var(--accent-purple);
            font-size: 1.1rem;
        }

        .info-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .info-modal-close:hover {
            color: var(--accent-red);
        }

        .info-modal-body {
            padding: 1.5rem;
        }

        .info-section {
            margin-bottom: 1.5rem;
        }

        .info-section:last-child {
            margin-bottom: 0;
        }

        .info-section h5 {
            color: var(--accent-blue);
            font-size: 0.95rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-section p {
            color: var(--text-primary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .info-code-example {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            color: var(--accent-green);
            overflow-x: auto;
        }

        .info-highlight {
            background: rgba(241, 250, 140, 0.2);
            color: var(--accent-yellow);
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-family: monospace;
        }

        .info-formula {
            background: rgba(139, 233, 253, 0.1);
            border-left: 3px solid var(--accent-blue);
            padding: 0.75rem 1rem;
            margin: 0.5rem 0;
            font-family: monospace;
            color: var(--accent-blue);
        }

        .info-list {
            padding-left: 1.25rem;
            margin: 0.5rem 0;
        }

        .info-list li {
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 0.35rem;
        }

        .info-tip {
            background: rgba(80, 250, 123, 0.1);
            border: 1px solid var(--accent-green);
            border-radius: 6px;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
        }

        .info-tip-title {
            color: var(--accent-green);
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }

        .info-tip p {
            margin: 0;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-leaf me-2"></i>OpenCV 教學平台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">
                            <i class="fas fa-home me-1"></i>首頁
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('playground') }}">
                            <i class="fas fa-flask me-1"></i>Playground
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('vi_lab') }}">
                            <i class="fas fa-code me-1"></i>程式實作區
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-terminal me-2"></i>程式實作區</h1>
                    <p class="text-secondary mb-0">撰寫 Python 程式碼，分階段執行植生指標計算</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="toolbar-btn" onclick="addCell()">
                        <i class="fas fa-plus me-1"></i>新增儲存格
                    </button>
                    <button class="toolbar-btn" onclick="runAllCells()">
                        <i class="fas fa-play me-1"></i>全部執行
                    </button>
                    <button class="toolbar-btn danger" onclick="resetSession()">
                        <i class="fas fa-redo me-1"></i>重置
                    </button>
                </div>
            </div>
        </div>

        <div class="main-container">
            <!-- Notebook Area -->
            <div class="notebook-area">
                <div class="notebook-header">
                    <h5><i class="fas fa-book-open me-2"></i>程式碼編輯區</h5>
                    <span class="text-secondary" style="font-size: 0.85rem;">
                        變數 <code>img</code> 已預先載入範例圖片
                    </span>
                </div>
                <div class="notebook-body" id="notebookBody">
                    <!-- Cells will be added here -->
                </div>
            </div>

            <!-- Right Panel -->
            <div class="right-panel">
                <!-- Sample Image -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-image me-2"></i>範例圖片 (img)</h6>
                    </div>
                    <div class="panel-body">
                        <div class="sample-image-container">
                            <img id="sampleImage" src="" alt="範例圖片" onclick="showImageModal(this.src)" style="cursor: pointer;">
                            <div class="sample-image-info" id="sampleImageInfo">載入中...</div>
                            <button class="btn-upload-custom" onclick="document.getElementById('customImageInput').click()">
                                <i class="fas fa-upload me-1"></i>上傳自訂圖片
                            </button>
                            <input type="file" id="customImageInput" accept="image/*" style="display: none;" onchange="uploadCustomImage(this)">
                        </div>
                    </div>
                </div>

                <!-- Variables -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-database me-2"></i>目前變數</h6>
                    </div>
                    <div class="panel-body">
                        <div class="variables-list" id="variablesList">
                            <div class="text-secondary" style="font-size: 0.85rem;">尚未執行程式碼</div>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-tasks me-2"></i>作業步驟</h6>
                    </div>
                    <div class="panel-body">
                        <div class="instructions-box">
                            <ol>
                                <li>通道分離 (cv2.split)</li>
                                <li>正規化計算 (r, g, b)</li>
                                <li>植生指標計算</li>
                                <li>Otsu 閾值 (cv2.threshold)</li>
                                <li>產生二值化遮罩</li>
                                <li>遮罩切圖 (cv2.bitwise_and)</li>
                                <li>產生直方圖 (matplotlib)</li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- VI Reference -->
                <div class="panel-card">
                    <div class="panel-header">
                        <h6><i class="fas fa-calculator me-2"></i>植生指標公式</h6>
                    </div>
                    <div class="panel-body">
                        <div class="vi-reference">
                            {% for vi_id, vi_info in vi_indices.items() %}
                            <div class="vi-item">
                                <div class="vi-name">{{ vi_info.name }}</div>
                                <div class="vi-formula">{{ vi_info.formula }}</div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div class="image-modal" id="imageModal" onclick="hideImageModal()">
        <span class="image-modal-close" onclick="hideImageModal()">&times;</span>
        <img id="modalImage" src="" alt="放大圖片">
    </div>

    <!-- Info Modal -->
    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <div class="info-modal-header">
                <h4 id="infoModalTitle"><i class="fas fa-info-circle me-2"></i>步驟說明</h4>
                <button class="info-modal-close" onclick="hideInfoModal()">&times;</button>
            </div>
            <div class="info-modal-body" id="infoModalBody">
                <!-- Content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

    <script>
        // Session ID
        const sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

        // Cell counter
        let cellCounter = 0;
        const editors = {};

        // Default code templates with info
        const defaultCells = [
            {
                title: '步驟 1: 通道分離',
                code: `# 將 BGR 影像分離為三個通道
B, G, R = cv2.split(img)

print(f"影像形狀: {img.shape}")
print(f"R 通道形狀: {R.shape}, 資料類型: {R.dtype}")`,
                info: {
                    title: '步驟 1: 通道分離 (Channel Splitting)',
                    content: `
                        <div class="info-section">
                            <h5><i class="fas fa-question-circle"></i> 這是什麼？</h5>
                            <p>彩色影像由三個顏色通道組成：<span class="info-highlight">B (藍)</span>、<span class="info-highlight">G (綠)</span>、<span class="info-highlight">R (紅)</span>。通道分離就是將這三個通道各自取出，變成三張獨立的灰階圖。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-code"></i> 函數說明</h5>
                            <div class="info-code-example">cv2.split(img) → (B, G, R)</div>
                            <ul class="info-list">
                                <li><strong>輸入</strong>：BGR 彩色影像 (shape: H×W×3)</li>
                                <li><strong>輸出</strong>：三個單通道灰階圖 (各為 H×W)</li>
                                <li><strong>注意</strong>：OpenCV 使用 BGR 順序，不是 RGB！</li>
                            </ul>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-leaf"></i> 農業應用</h5>
                            <p>植物的葉片會反射較多的綠光，因此 <span class="info-highlight">G 通道</span> 的值通常較高。透過分析各通道的數值，可以判斷植物的健康狀況。</p>
                        </div>
                        <div class="info-tip">
                            <div class="info-tip-title"><i class="fas fa-lightbulb me-1"></i> 小提示</div>
                            <p>每個通道的值範圍是 0-255，0 代表該顏色完全沒有，255 代表該顏色最強。</p>
                        </div>
                    `
                }
            },
            {
                title: '步驟 2: 正規化計算',
                code: `# 計算正規化的 r, g, b 值
# 轉換為 float 避免溢位
R_f = R.astype(np.float32)
G_f = G.astype(np.float32)
B_f = B.astype(np.float32)

# 計算總和 (避免除以零)
total = R_f + G_f + B_f + 1e-6

# 正規化
r = R_f / total
g = G_f / total
b = B_f / total

print(f"r 範圍: {r.min():.4f} ~ {r.max():.4f}")
print(f"g 範圍: {g.min():.4f} ~ {g.max():.4f}")
print(f"b 範圍: {b.min():.4f} ~ {b.max():.4f}")`,
                info: {
                    title: '步驟 2: 色彩正規化 (Chromatic Normalization)',
                    content: `
                        <div class="info-section">
                            <h5><i class="fas fa-question-circle"></i> 為什麼需要正規化？</h5>
                            <p>直接使用 R、G、B 值會受到<strong>光照強度</strong>影響。同一片葉子在陽光下和陰影中，RGB 值會完全不同，但它的「顏色比例」是一致的。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-calculator"></i> 計算公式</h5>
                            <div class="info-formula">
                                r = R / (R + G + B)<br>
                                g = G / (R + G + B)<br>
                                b = B / (R + G + B)
                            </div>
                            <p>正規化後，r + g + b = 1，代表的是每個顏色的「佔比」。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-balance-scale"></i> 除以 total vs 除以 255</h5>
                            <p><strong>除以 255</strong>：得到亮度值 (0~1)，會受光照影響</p>
                            <p><strong>除以 total</strong>：得到顏色比例 (0~1)，不受光照影響</p>
                            <div class="info-code-example">
強光下: R=200, G=250, B=100 → g = 250/550 = 0.45<br>
弱光下: R=100, G=125, B=50  → g = 125/275 = 0.45 ✓ 一致！
                            </div>
                        </div>
                        <div class="info-tip">
                            <div class="info-tip-title"><i class="fas fa-lightbulb me-1"></i> 色彩恆常性</div>
                            <p>這種方法稱為「色彩恆常性 (Color Constancy)」，讓演算法在不同光照條件下都能穩定運作。</p>
                        </div>
                    `
                }
            },
            {
                title: '步驟 3: 植生指標計算',
                code: `# 計算 ExG (Excess Green) 植生指標
# 公式: ExG = 2g - r - b
ExG = 2 * g - r - b

print(f"ExG 範圍: {ExG.min():.4f} ~ {ExG.max():.4f}")
print(f"ExG 平均值: {ExG.mean():.4f}")`,
                info: {
                    title: '步驟 3: 植生指標 (Vegetation Index)',
                    content: `
                        <div class="info-section">
                            <h5><i class="fas fa-question-circle"></i> 什麼是植生指標？</h5>
                            <p>植生指標是一個數學公式，用來<strong>量化</strong>影像中某個像素是否為植物。數值越高，越可能是植物。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-calculator"></i> ExG (Excess Green) 公式</h5>
                            <div class="info-formula">ExG = 2g - r - b</div>
                            <p>公式解讀：「綠色佔比」的兩倍，減去「紅色佔比」和「藍色佔比」。</p>
                            <ul class="info-list">
                                <li><strong>ExG > 0</strong>：綠色佔比高，很可能是植物</li>
                                <li><strong>ExG ≈ 0</strong>：顏色平均，可能是灰色物體</li>
                                <li><strong>ExG < 0</strong>：綠色佔比低，不是植物</li>
                            </ul>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-list"></i> 其他常見植生指標</h5>
                            <ul class="info-list">
                                <li><strong>ExGR</strong> = ExG - 1.4r - g (排除紅色干擾)</li>
                                <li><strong>GLI</strong> = (2g - r - b) / (2g + r + b)</li>
                                <li><strong>VARI</strong> = (g - r) / (g + r - b)</li>
                                <li><strong>NGRDI</strong> = (g - r) / (g + r)</li>
                            </ul>
                        </div>
                        <div class="info-tip">
                            <div class="info-tip-title"><i class="fas fa-lightbulb me-1"></i> 選擇指標</div>
                            <p>不同的植生指標適合不同場景，ExG 簡單有效，適合一般田間影像。</p>
                        </div>
                    `
                }
            },
            {
                title: '步驟 4: 正規化至 0-255 並計算 Otsu 閾值',
                code: `# 將植生指標正規化到 0-255
vi_normalized = cv2.normalize(ExG, None, 0, 255, cv2.NORM_MINMAX)
vi_uint8 = vi_normalized.astype(np.uint8)

# 使用 Otsu 方法計算最佳閾值
threshold_value, mask = cv2.threshold(vi_uint8, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)

print(f"Otsu 閾值: {threshold_value}")`,
                info: {
                    title: '步驟 4: Otsu 自動閾值法',
                    content: `
                        <div class="info-section">
                            <h5><i class="fas fa-question-circle"></i> 什麼是閾值 (Threshold)？</h5>
                            <p>閾值是一個「分界點」，用來將灰階影像轉換為二值影像（只有黑和白）。像素值大於閾值變成白色 (255)，小於則變成黑色 (0)。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-magic"></i> Otsu 方法的優點</h5>
                            <p>Otsu 是一種<strong>自動計算最佳閾值</strong>的演算法，不需要人工設定。它會分析影像的直方圖，找出能讓「前景」和「背景」分離最明顯的閾值。</p>
                            <div class="info-code-example">
cv2.threshold(img, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)<br>
# 第二個參數設為 0，讓 Otsu 自動決定
                            </div>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-cogs"></i> 函數回傳值</h5>
                            <ul class="info-list">
                                <li><strong>threshold_value</strong>：Otsu 計算出的最佳閾值</li>
                                <li><strong>mask</strong>：二值化後的遮罩影像</li>
                            </ul>
                        </div>
                        <div class="info-tip">
                            <div class="info-tip-title"><i class="fas fa-lightbulb me-1"></i> 為什麼要先正規化？</div>
                            <p>ExG 的值範圍是 -1 到 1，但 cv2.threshold 需要 0-255 的 uint8 影像，所以要先做正規化轉換。</p>
                        </div>
                    `
                }
            },
            {
                title: '步驟 5: 使用遮罩切割原圖',
                code: `# 使用遮罩提取植物區域
result = cv2.bitwise_and(img, img, mask=mask)

# 計算植被覆蓋率
vegetation_pixels = np.sum(mask == 255)
total_pixels = mask.shape[0] * mask.shape[1]
coverage = (vegetation_pixels / total_pixels) * 100

print(f"植被覆蓋率: {coverage:.2f}%")`,
                info: {
                    title: '步驟 5: 遮罩切割 (Masking)',
                    content: `
                        <div class="info-section">
                            <h5><i class="fas fa-question-circle"></i> 什麼是遮罩？</h5>
                            <p>遮罩 (Mask) 就像一張「蓋板」，白色區域 (255) 代表要保留，黑色區域 (0) 代表要遮蔽。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-code"></i> bitwise_and 運算</h5>
                            <div class="info-code-example">result = cv2.bitwise_and(img, img, mask=mask)</div>
                            <p>這個函數會將原圖與遮罩做「位元 AND 運算」：</p>
                            <ul class="info-list">
                                <li>遮罩為 255 的位置：保留原圖像素</li>
                                <li>遮罩為 0 的位置：變成黑色 (0, 0, 0)</li>
                            </ul>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-chart-pie"></i> 植被覆蓋率計算</h5>
                            <div class="info-formula">覆蓋率 = (白色像素數 / 總像素數) × 100%</div>
                            <p>這個數值可以用來評估田間的植物覆蓋程度、生長狀況等。</p>
                        </div>
                        <div class="info-tip">
                            <div class="info-tip-title"><i class="fas fa-lightbulb me-1"></i> 農業應用</div>
                            <p>植被覆蓋率可用於：監測作物生長進度、評估肥料效果、偵測病蟲害區域等。</p>
                        </div>
                    `
                }
            },
            {
                title: '步驟 6: 產生直方圖',
                code: `# 使用 matplotlib 產生直方圖
import matplotlib
matplotlib.use('Agg')  # 非互動模式
import matplotlib.pyplot as plt
import io
import base64

# 設定中文字型
plt.rcParams['font.sans-serif'] = ['Microsoft JhengHei', 'SimHei', 'Arial Unicode MS', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False

# 取得植被區域的 ExG 值
vegetation_values = ExG[mask == 255].flatten()

# 繪製直方圖
fig, ax = plt.subplots(figsize=(8, 5))
ax.hist(vegetation_values, bins=50, color='green', alpha=0.7, edgecolor='darkgreen')
ax.axvline(x=threshold_value/255, color='red', linestyle='--', linewidth=2, label='Otsu 閾值')
ax.set_xlabel('ExG 值', fontsize=12)
ax.set_ylabel('像素數量', fontsize=12)
ax.set_title(f'植被區域 ExG 分布 (覆蓋率: {coverage:.1f}%)', fontsize=14)
ax.legend()
ax.grid(True, alpha=0.3)

# 轉換為 base64
buf = io.BytesIO()
fig.savefig(buf, format='png', dpi=100, bbox_inches='tight')
buf.seek(0)
histogram_img = 'data:image/png;base64,' + base64.b64encode(buf.read()).decode('utf-8')
plt.close(fig)

print("直方圖已產生！")`,
                info: {
                    title: '步驟 6: 直方圖視覺化',
                    content: `
                        <div class="info-section">
                            <h5><i class="fas fa-question-circle"></i> 為什麼要畫直方圖？</h5>
                            <p>直方圖可以顯示植被區域中 ExG 值的<strong>分布情況</strong>，幫助我們了解植物的整體特徵。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-chart-bar"></i> 直方圖解讀</h5>
                            <ul class="info-list">
                                <li><strong>X 軸</strong>：ExG 植生指標值</li>
                                <li><strong>Y 軸</strong>：具有該值的像素數量</li>
                                <li><strong>紅色虛線</strong>：Otsu 閾值的位置</li>
                            </ul>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-code"></i> 程式碼重點</h5>
                            <div class="info-code-example">
ExG[mask == 255]  # 只取植被區域的 ExG 值<br>
.flatten()        # 將 2D 陣列轉為 1D
                            </div>
                            <p>我們只分析被判定為植物的區域，忽略背景。</p>
                        </div>
                        <div class="info-section">
                            <h5><i class="fas fa-image"></i> 轉換為 Base64</h5>
                            <p>由於我們在伺服器端執行，無法直接顯示圖片。將圖片轉換為 Base64 字串後，可以嵌入到網頁中顯示。</p>
                        </div>
                        <div class="info-tip">
                            <div class="info-tip-title"><i class="fas fa-lightbulb me-1"></i> 健康評估</div>
                            <p>若直方圖集中在較高的 ExG 值，代表植物綠色濃郁、可能較健康；若分布較低，可能表示植物枯黃或生長不良。</p>
                        </div>
                    `
                }
            }
        ];

        // Store cell info for modal
        const cellInfoMap = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleImage();

            // Add default cells
            defaultCells.forEach(cell => {
                addCell(cell.title, cell.code, cell.info);
            });
        });

        // Load sample image
        function loadSampleImage() {
            fetch('{{ url_for("get_sample_image") }}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('sampleImage').src = data.image;
                        document.getElementById('sampleImageInfo').textContent =
                            `shape: (${data.shape.join(', ')})`;
                    } else {
                        document.getElementById('sampleImageInfo').textContent = '圖片載入失敗';
                    }
                })
                .catch(error => {
                    document.getElementById('sampleImageInfo').textContent = '圖片載入失敗';
                });
        }

        // Add new cell
        function addCell(title = '', code = '', info = null) {
            cellCounter++;
            const cellId = `cell_${cellCounter}`;

            // Store info if provided
            if (info) {
                cellInfoMap[cellId] = info;
            }

            // Info button HTML (only if info exists)
            const infoButtonHtml = info ?
                `<button class="btn-info-cell" onclick="showInfoModal('${cellId}')">
                    <i class="fas fa-question-circle me-1"></i>說明
                </button>` : '';

            const cellHtml = `
                <div class="code-cell" id="${cellId}">
                    <div class="cell-header">
                        <div>
                            <span class="cell-number">[${cellCounter}]</span>
                            <span class="cell-title">${title || '程式碼儲存格'}</span>
                        </div>
                        <div class="cell-actions">
                            ${infoButtonHtml}
                            <div class="cell-loading" id="${cellId}_loading">
                                <div class="spinner-sm"></div>
                                <span>執行中...</span>
                            </div>
                            <button class="btn-run" onclick="runCell('${cellId}')">
                                <i class="fas fa-play me-1"></i>執行
                            </button>
                            <button class="toolbar-btn" onclick="deleteCell('${cellId}')" style="padding: 0.25rem 0.5rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="cell-editor" id="${cellId}_editor"></div>
                    <div class="cell-output" id="${cellId}_output"></div>
                </div>
            `;

            document.getElementById('notebookBody').insertAdjacentHTML('beforeend', cellHtml);

            // Initialize CodeMirror
            const editor = CodeMirror(document.getElementById(`${cellId}_editor`), {
                value: code,
                mode: 'python',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: true,
                extraKeys: {
                    'Shift-Enter': function(cm) {
                        runCell(cellId);
                    },
                    'Tab': function(cm) {
                        cm.replaceSelection('    ', 'end');
                    }
                }
            });

            editors[cellId] = editor;
        }

        // Delete cell
        function deleteCell(cellId) {
            const cell = document.getElementById(cellId);
            if (cell && Object.keys(editors).length > 1) {
                cell.remove();
                delete editors[cellId];
            }
        }

        // Run cell
        async function runCell(cellId) {
            const editor = editors[cellId];
            const code = editor.getValue();
            const cell = document.getElementById(cellId);
            const loading = document.getElementById(`${cellId}_loading`);
            const output = document.getElementById(`${cellId}_output`);

            // Update UI
            cell.className = 'code-cell running';
            loading.classList.add('show');

            try {
                const requestBody = {
                    code: code,
                    session_id: sessionId,
                    cell_id: cellId
                };

                // 如果有上傳自訂圖片，加入檔名
                if (customFilename) {
                    requestBody.custom_filename = customFilename;
                }

                const response = await fetch('{{ url_for("execute_code") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                // Show output
                output.classList.add('show');

                if (data.success) {
                    cell.className = 'code-cell success';

                    let outputHtml = '';

                    // Text output
                    if (data.output) {
                        outputHtml += `
                            <div class="output-label">Output:</div>
                            <div class="output-text">${escapeHtml(data.output)}</div>
                        `;
                    }

                    // Images
                    if (data.images && Object.keys(data.images).length > 0) {
                        outputHtml += '<div class="output-images">';
                        for (const [name, src] of Object.entries(data.images)) {
                            outputHtml += `
                                <div class="output-image-item">
                                    <img src="${src}" alt="${name}" onclick="showImageModal('${src.replace(/'/g, "\\'")}')">
                                    <div class="output-image-label">${name}</div>
                                </div>
                            `;
                        }
                        outputHtml += '</div>';
                    }

                    output.innerHTML = outputHtml || '<div class="text-secondary">執行完成 (無輸出)</div>';

                    // Update variables panel
                    updateVariablesPanel(data.variables);

                } else {
                    cell.className = 'code-cell error';
                    output.innerHTML = `
                        <div class="output-label">Error:</div>
                        <div class="output-text output-error">${escapeHtml(data.error)}\n\n${escapeHtml(data.traceback || '')}</div>
                    `;
                }

            } catch (error) {
                cell.className = 'code-cell error';
                output.classList.add('show');
                output.innerHTML = `
                    <div class="output-label">Error:</div>
                    <div class="output-text output-error">網路錯誤: ${error.message}</div>
                `;
            } finally {
                loading.classList.remove('show');
            }
        }

        // Run all cells
        async function runAllCells() {
            for (const cellId of Object.keys(editors)) {
                await runCell(cellId);
            }
        }

        // Reset session
        async function resetSession() {
            if (!confirm('確定要重置嗎？所有變數將被清除。')) return;

            try {
                await fetch('{{ url_for("reset_session") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });

                // Clear all outputs
                document.querySelectorAll('.cell-output').forEach(el => {
                    el.classList.remove('show');
                    el.innerHTML = '';
                });

                document.querySelectorAll('.code-cell').forEach(el => {
                    el.className = 'code-cell';
                });

                // Clear variables panel
                document.getElementById('variablesList').innerHTML =
                    '<div class="text-secondary" style="font-size: 0.85rem;">尚未執行程式碼</div>';

            } catch (error) {
                alert('重置失敗: ' + error.message);
            }
        }

        // Update variables panel
        function updateVariablesPanel(variables) {
            const panel = document.getElementById('variablesList');

            if (!variables || Object.keys(variables).length === 0) {
                panel.innerHTML = '<div class="text-secondary" style="font-size: 0.85rem;">尚無變數</div>';
                return;
            }

            let html = '';
            for (const [name, info] of Object.entries(variables)) {
                html += `
                    <div class="var-item">
                        <span class="var-name">${name}</span>
                        <span class="var-type">${info}</span>
                    </div>
                `;
            }

            panel.innerHTML = html;
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Image Modal
        function showImageModal(src) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = src;
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // ESC key to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideImageModal();
                hideInfoModal();
            }
        });

        // Info Modal Functions
        function showInfoModal(cellId) {
            const info = cellInfoMap[cellId];
            if (!info) return;

            document.getElementById('infoModalTitle').innerHTML =
                `<i class="fas fa-info-circle me-2"></i>${info.title}`;
            document.getElementById('infoModalBody').innerHTML = info.content;

            const modal = document.getElementById('infoModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Close info modal when clicking outside content
        document.getElementById('infoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideInfoModal();
            }
        });

        // Upload Custom Image
        let customFilename = null;

        async function uploadCustomImage(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('{{ url_for("upload") }}', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    customFilename = data.filename;

                    // Update sample image display
                    document.getElementById('sampleImage').src = data.url;
                    document.getElementById('sampleImageInfo').textContent = '自訂圖片 (已上傳)';

                    // Reset session to use new image
                    await fetch('{{ url_for("reset_session") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ session_id: sessionId })
                    });

                    // Clear outputs
                    document.querySelectorAll('.cell-output').forEach(el => {
                        el.classList.remove('show');
                        el.innerHTML = '';
                    });
                    document.querySelectorAll('.code-cell').forEach(el => {
                        el.className = 'code-cell';
                    });
                    document.getElementById('variablesList').innerHTML =
                        '<div class="text-secondary" style="font-size: 0.85rem;">尚未執行程式碼</div>';

                    alert('圖片上傳成功！請重新執行程式碼。');
                } else {
                    alert('上傳失敗：' + (data.error || '未知錯誤'));
                }
            } catch (error) {
                alert('上傳失敗：' + error.message);
            }

            input.value = '';
        }
    </script>
</body>
</html>
