{% extends "base.html" %}

{% block title %}操作頁面 - OpenCV 教學平台{% endblock %}

{% block extra_head %}
<style>
    /* ===== 模式切換 Tab ===== */
    .mode-tabs {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        padding: 0;
    }
    .mode-tabs .nav-link {
        color: rgba(255,255,255,0.7);
        border: none;
        border-radius: 0;
        padding: 12px 30px;
        font-weight: bold;
        font-size: 1rem;
        transition: all 0.3s;
    }
    .mode-tabs .nav-link:hover {
        color: white;
        background: rgba(255,255,255,0.1);
    }
    .mode-tabs .nav-link.active {
        color: white;
        background: rgba(13, 202, 240, 0.3);
        border-bottom: 3px solid #0dcaf0;
    }
    .mode-tabs .nav-link .badge {
        font-size: 0.65rem;
        vertical-align: middle;
        margin-left: 5px;
    }

    .sidebar {
        height: calc(100vh - 100px);
        overflow-y: auto;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
    }
    .main-content {
        height: calc(100vh - 100px);
        overflow-y: auto;
    }
    .effect-btn {
        text-align: left;
        border: none;
        background: none;
        padding: 8px 16px;
        width: 100%;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
    }
    .effect-btn:hover {
        background: #e9ecef;
    }
    .effect-btn.active {
        background: #0dcaf0;
        color: white;
    }
    .numpy-btn.active {
        background: #198754;
        color: white;
    }
    .category-header {
        font-weight: bold;
        padding: 10px 16px;
        background: #dee2e6;
        margin-top: 10px;
        font-size: 0.85rem;
    }
    .category-header:first-child {
        margin-top: 0;
    }
    .numpy-category-header {
        background: #d1e7dd;
    }
    .image-container {
        min-height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f0f0f0;
        border-radius: 8px;
    }
    .image-container img {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
    }
    .code-container {
        max-height: 300px;
        overflow-y: auto;
    }
    .upload-zone {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-zone:hover {
        border-color: #0dcaf0;
        background: #f8f9fa;
    }
    .upload-zone.dragover {
        border-color: #0dcaf0;
        background: #e0f7fa;
    }
    .loading {
        display: none;
    }
    .loading.show {
        display: block;
    }
    pre code {
        font-size: 0.8rem;
    }
    /* 說明區塊 */
    .description-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
    }
    .description-box h5 {
        margin-bottom: 10px;
        font-weight: bold;
    }
    .description-box p {
        margin-bottom: 0;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    /* 參數控制區 */
    .params-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
    }
    .params-box h6 {
        color: #856404;
        margin-bottom: 15px;
        font-weight: bold;
    }
    .param-group {
        margin-bottom: 15px;
    }
    .param-group:last-child {
        margin-bottom: 0;
    }
    .param-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .param-value {
        color: #0d6efd;
        font-weight: bold;
        font-size: 0.9rem;
    }
    .form-range {
        width: 100%;
    }
    .form-select, .form-check-input {
        cursor: pointer;
    }
    .no-params {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 10px;
    }
    /* 套用按鈕 */
    .apply-btn {
        width: 100%;
        padding: 10px;
        font-weight: bold;
    }
    /* 像素顏色顯示器 */
    .pixel-info-box {
        background: #2d3748;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-family: monospace;
    }
    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .pixel-values {
        flex: 1;
    }
    .pixel-values small {
        font-size: 0.8rem;
    }

    /* ===== NumPy 陣列視覺化 ===== */
    .array-grid {
        display: inline-block;
        border: 2px solid #333;
        border-radius: 4px;
        overflow: hidden;
        font-family: 'Consolas', 'Monaco', monospace;
    }
    .array-row {
        display: flex;
    }
    .array-cell {
        min-width: 40px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ddd;
        font-size: 0.75rem;
        font-weight: 500;
        transition: all 0.2s;
        padding: 2px 4px;
    }
    .array-cell.highlight {
        border: 2px solid #dc3545;
        z-index: 1;
        position: relative;
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.5);
    }
    .array-cell.selected {
        background: #ffc107 !important;
        color: #000 !important;
        font-weight: bold;
    }
    .array-info {
        font-family: monospace;
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 8px;
    }
    .array-container {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        min-height: 200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .array-label {
        font-weight: bold;
        color: #495057;
        margin-bottom: 10px;
    }
    .array-arrow {
        font-size: 2rem;
        color: #198754;
        margin: 0 15px;
    }
    .arrays-comparison {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    .scalar-result {
        font-size: 2rem;
        font-weight: bold;
        color: #198754;
        background: #d1e7dd;
        padding: 15px 30px;
        border-radius: 10px;
        font-family: monospace;
    }
    .numpy-description-box {
        background: linear-gradient(135deg, #198754 0%, #20c997 100%);
        color: white;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
    }
    .numpy-params-box {
        background: #d1e7dd;
        border: 1px solid #198754;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
    }
    .numpy-params-box h6 {
        color: #0f5132;
        margin-bottom: 15px;
        font-weight: bold;
    }
    .source-toggle {
        background: #e2e3e5;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 15px;
    }
    .source-toggle .btn-check:checked + .btn {
        background: #198754;
        color: white;
    }
    .requires-image-badge {
        font-size: 0.65rem;
        background: #0dcaf0;
        color: white;
        padding: 2px 5px;
        border-radius: 3px;
        margin-left: 5px;
    }
    .list-result {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        font-family: monospace;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<!-- 模式切換 Tab -->
<ul class="nav mode-tabs" id="modeTabs">
    <li class="nav-item">
        <button class="nav-link active" data-mode="opencv" id="opencvTab">
            OpenCV 影像處理
            <span class="badge bg-info">{{ categories|length }} 類</span>
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-mode="numpy" id="numpyTab">
            NumPy 陣列運算
            <span class="badge bg-success">{{ numpy_categories|length }} 類</span>
        </button>
    </li>
</ul>

<div class="container-fluid">
    <div class="row">
        <!-- ===== OpenCV 左側選單 ===== -->
        <div class="col-md-3 col-lg-2 p-0 sidebar" id="opencvSidebar">
            {% for category, effects in categories.items() %}
            <div class="category-header">{{ category }}</div>
            {% for effect in effects %}
            <button class="effect-btn opencv-btn" data-effect="{{ effect.id }}">
                {{ effect.name }}
            </button>
            {% endfor %}
            {% endfor %}
        </div>

        <!-- ===== NumPy 左側選單 ===== -->
        <div class="col-md-3 col-lg-2 p-0 sidebar" id="numpySidebar" style="display: none;">
            {% for category, effects in numpy_categories.items() %}
            <div class="category-header numpy-category-header">{{ category }}</div>
            {% for effect in effects %}
            <button class="effect-btn numpy-btn" data-effect="{{ effect.id }}" data-requires-image="{{ effect.requires_image|lower }}">
                {{ effect.name }}
                {% if effect.requires_image %}
                <span class="requires-image-badge">需圖片</span>
                {% endif %}
            </button>
            {% endfor %}
            {% endfor %}
        </div>

        <!-- 主要內容區 -->
        <div class="col-md-9 col-lg-10 main-content p-4">

            <!-- ===== OpenCV 內容區 ===== -->
            <div id="opencvContent">
            <!-- 上傳區域 -->
            <div id="uploadSection" class="mb-4">
                <div class="upload-zone" id="uploadZone">
                    <div class="mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="text-muted" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                    </div>
                    <h4>拖曳圖片到這裡</h4>
                    <p class="text-muted mb-2">或點擊選擇檔案</p>
                    <p class="text-muted small">支援 PNG, JPG, GIF, BMP, WebP (最大 16MB)</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
            </div>

            <!-- 結果區域 -->
            <div id="resultSection" style="display: none;">
                <!-- 說明區塊（簡化版） -->
                <div class="description-box d-flex justify-content-between align-items-center" id="descriptionBox">
                    <div>
                        <h5 class="mb-1" id="descTitle">原始影像</h5>
                        <p class="mb-0 small opacity-75" id="descSummary">顯示原始上傳的影像</p>
                    </div>
                    <button class="btn btn-light btn-sm" id="showDescModalBtn" data-bs-toggle="modal" data-bs-target="#descModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                        詳細說明
                    </button>
                </div>

                <div class="row">
                    <!-- 左側：圖片顯示 -->
                    <div class="col-lg-8">
                        <div class="row">
                            <!-- 原圖 -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white py-2">
                                        <h6 class="mb-0 small">原始影像</h6>
                                    </div>
                                    <div class="card-body image-container p-2">
                                        <img id="originalImage" src="" alt="原始影像">
                                    </div>
                                </div>
                            </div>

                            <!-- 處理後 -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-info text-white py-2 d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 small">處理結果</h6>
                                        <div class="spinner-border spinner-border-sm text-light loading" id="loadingSpinner" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="card-body image-container p-2" style="position: relative;">
                                        <img id="resultImage" src="" alt="處理結果" style="cursor: crosshair;">
                                        <canvas id="pixelCanvas" style="display: none;"></canvas>
                                    </div>
                                </div>
                                <!-- 像素顏色顯示器 -->
                                <div class="pixel-info-box mt-2" id="pixelInfoBox" style="display: none;">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="color-preview" id="colorPreview"></div>
                                        <div class="pixel-values">
                                            <div><small>座標: (<span id="pixelX">-</span>, <span id="pixelY">-</span>)</small></div>
                                            <div id="pixelValuesDisplay"><small>RGB: (-, -, -)</small></div>
                                            <div id="extraChannelInfo"><small></small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 程式碼區域 -->
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white py-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 small">Python 程式碼</h6>
                                <button class="btn btn-sm btn-outline-light py-0" id="copyCodeBtn">複製</button>
                            </div>
                            <div class="card-body code-container p-0">
                                <pre class="m-0"><code id="codeBlock" class="python"></code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：參數控制 -->
                    <div class="col-lg-4">
                        <div class="params-box">
                            <h6>參數調整</h6>
                            <div id="paramsContainer">
                                <div class="no-params">此效果沒有可調整的參數</div>
                            </div>
                            <hr class="my-3">
                            <button class="btn btn-warning apply-btn" id="applyBtn">
                                套用效果
                            </button>
                        </div>

                        <!-- 重新上傳 -->
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-secondary btn-sm" id="resetBtn">
                                上傳新圖片
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div><!-- /opencvContent -->

            <!-- ===== NumPy 內容區 ===== -->
            <div id="numpyContent" style="display: none;">
                <!-- 說明區塊（簡化版） -->
                <div class="numpy-description-box d-flex justify-content-between align-items-center" id="numpyDescriptionBox">
                    <div>
                        <h5 class="mb-1" id="numpyDescTitle">NumPy 陣列運算</h5>
                        <p class="mb-0 small opacity-75" id="numpyDescSummary">選擇左側的操作來開始學習</p>
                    </div>
                    <button class="btn btn-light btn-sm" id="showNumpyDescModalBtn" data-bs-toggle="modal" data-bs-target="#numpyDescModal">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                            <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                        </svg>
                        詳細說明
                    </button>
                </div>

                <div class="row">
                    <!-- 左側：陣列視覺化 -->
                    <div class="col-lg-8">
                        <!-- 輸入來源選擇（僅圖片相關效果顯示） -->
                        <div class="source-toggle mb-3" id="sourceToggle" style="display: none;">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="numpySource" id="sourceSample" value="sample" checked>
                                <label class="btn btn-outline-secondary" for="sourceSample">使用範例陣列</label>
                                <input type="radio" class="btn-check" name="numpySource" id="sourceImage" value="image">
                                <label class="btn btn-outline-secondary" for="sourceImage">使用上傳圖片</label>
                            </div>
                        </div>

                        <!-- NumPy 圖片上傳區（需要圖片時顯示） -->
                        <div id="numpyUploadSection" class="mb-4" style="display: none;">
                            <div class="upload-zone" id="numpyUploadZone">
                                <div class="mb-3">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="text-success" viewBox="0 0 16 16">
                                        <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                                        <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                    </svg>
                                </div>
                                <h5>上傳圖片以進行 NumPy 操作</h5>
                                <p class="text-muted small">圖片將作為 NumPy 陣列進行處理</p>
                                <input type="file" id="numpyFileInput" accept="image/*" style="display: none;">
                            </div>
                        </div>

                        <!-- 陣列視覺化區域 -->
                        <div class="row" id="numpyResultSection">
                            <!-- 輸入陣列 -->
                            <div class="col-md-6 mb-3" id="inputArrayCol">
                                <div class="array-container" id="inputArrayContainer">
                                    <div class="array-label">輸入陣列</div>
                                    <div id="inputArrayDisplay">
                                        <div class="text-muted">選擇操作後顯示</div>
                                    </div>
                                    <div class="array-info" id="inputArrayInfo"></div>
                                </div>
                            </div>

                            <!-- 輸出陣列 -->
                            <div class="col-md-6 mb-3" id="outputArrayCol">
                                <div class="array-container" id="outputArrayContainer">
                                    <div class="array-label">輸出結果</div>
                                    <div id="outputArrayDisplay">
                                        <div class="text-muted">選擇操作後顯示</div>
                                    </div>
                                    <div class="array-info" id="outputArrayInfo"></div>
                                </div>
                            </div>
                        </div>

                        <!-- NumPy 程式碼區域 -->
                        <div class="card mb-3">
                            <div class="card-header bg-success text-white py-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 small">Python 程式碼</h6>
                                <button class="btn btn-sm btn-outline-light py-0" id="copyNumpyCodeBtn">複製</button>
                            </div>
                            <div class="card-body code-container p-0">
                                <pre class="m-0"><code id="numpyCodeBlock" class="python"># 選擇左側的操作來查看程式碼</code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：參數控制 -->
                    <div class="col-lg-4">
                        <div class="numpy-params-box">
                            <h6>參數調整</h6>
                            <div id="numpyParamsContainer">
                                <div class="no-params">選擇操作來調整參數</div>
                            </div>
                            <hr class="my-3">
                            <button class="btn btn-success apply-btn" id="numpyApplyBtn">
                                執行操作
                            </button>
                        </div>
                    </div>
                </div>
            </div><!-- /numpyContent -->

        </div>
    </div>
</div>

<!-- OpenCV 說明 Modal -->
<div class="modal fade" id="descModal" tabindex="-1" aria-labelledby="descModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="descModalLabel">效果說明</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="modalDescTitle">效果名稱</h4>
                <div id="modalDescText" class="mt-3" style="white-space: pre-line; line-height: 1.8;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

<!-- NumPy 說明 Modal -->
<div class="modal fade" id="numpyDescModal" tabindex="-1" aria-labelledby="numpyDescModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="numpyDescModalLabel">操作說明</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="numpyModalDescTitle">操作名稱</h4>
                <div id="numpyModalDescText" class="mt-3" style="white-space: pre-line; line-height: 1.8;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// ===== 模式控制 =====
let currentMode = 'opencv';  // 'opencv' or 'numpy'

// ===== OpenCV 相關 =====
let effectsData = {};
let currentFilename = null;
let currentEffect = 'original';
let currentParams = {};

// ===== NumPy 相關 =====
let numpyEffectsData = {};
let numpyFilename = null;
let currentNumpyEffect = 'array_create';
let currentNumpyParams = {};

// ===== DOM 元素 - OpenCV =====
const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const uploadSection = document.getElementById('uploadSection');
const resultSection = document.getElementById('resultSection');
const originalImage = document.getElementById('originalImage');
const resultImage = document.getElementById('resultImage');
const descTitle = document.getElementById('descTitle');
const descSummary = document.getElementById('descSummary');
const codeBlock = document.getElementById('codeBlock');
const loadingSpinner = document.getElementById('loadingSpinner');
const paramsContainer = document.getElementById('paramsContainer');
const opencvBtns = document.querySelectorAll('.opencv-btn');
const copyCodeBtn = document.getElementById('copyCodeBtn');
const resetBtn = document.getElementById('resetBtn');
const applyBtn = document.getElementById('applyBtn');

// ===== DOM 元素 - OpenCV Modal =====
const modalDescTitle = document.getElementById('modalDescTitle');
const modalDescText = document.getElementById('modalDescText');

// ===== DOM 元素 - 模式切換 =====
const opencvTab = document.getElementById('opencvTab');
const numpyTab = document.getElementById('numpyTab');
const opencvContent = document.getElementById('opencvContent');
const numpyContent = document.getElementById('numpyContent');
const opencvSidebar = document.getElementById('opencvSidebar');
const numpySidebar = document.getElementById('numpySidebar');

// ===== DOM 元素 - NumPy =====
const numpyBtns = document.querySelectorAll('.numpy-btn');
const numpyDescTitle = document.getElementById('numpyDescTitle');
const numpyDescSummary = document.getElementById('numpyDescSummary');
const numpyCodeBlock = document.getElementById('numpyCodeBlock');
const numpyParamsContainer = document.getElementById('numpyParamsContainer');
const numpyApplyBtn = document.getElementById('numpyApplyBtn');
const copyNumpyCodeBtn = document.getElementById('copyNumpyCodeBtn');
const inputArrayDisplay = document.getElementById('inputArrayDisplay');
const outputArrayDisplay = document.getElementById('outputArrayDisplay');
const inputArrayInfo = document.getElementById('inputArrayInfo');
const outputArrayInfo = document.getElementById('outputArrayInfo');
const sourceToggle = document.getElementById('sourceToggle');
const numpyUploadSection = document.getElementById('numpyUploadSection');
const numpyUploadZone = document.getElementById('numpyUploadZone');
const numpyFileInput = document.getElementById('numpyFileInput');
const inputArrayContainer = document.getElementById('inputArrayContainer');
const outputArrayContainer = document.getElementById('outputArrayContainer');

// ===== DOM 元素 - NumPy Modal =====
const numpyModalDescTitle = document.getElementById('numpyModalDescTitle');
const numpyModalDescText = document.getElementById('numpyModalDescText');

// ===== 模式切換 =====
function switchMode(mode) {
    currentMode = mode;

    // 更新 Tab 狀態
    opencvTab.classList.toggle('active', mode === 'opencv');
    numpyTab.classList.toggle('active', mode === 'numpy');

    // 切換側邊欄
    opencvSidebar.style.display = mode === 'opencv' ? 'block' : 'none';
    numpySidebar.style.display = mode === 'numpy' ? 'block' : 'none';

    // 切換內容區
    opencvContent.style.display = mode === 'opencv' ? 'block' : 'none';
    numpyContent.style.display = mode === 'numpy' ? 'block' : 'none';

    // NumPy 模式初始化
    if (mode === 'numpy' && !numpyEffectsData.array_create) {
        loadNumpyEffectsData();
    }
}

opencvTab.addEventListener('click', () => switchMode('opencv'));
numpyTab.addEventListener('click', () => switchMode('numpy'));

// 載入效果資料
async function loadEffectsData() {
    try {
        const response = await fetch('{{ url_for("effects") }}');
        effectsData = await response.json();
    } catch (error) {
        console.error('載入效果資料失敗:', error);
    }
}

// 初始化時載入效果資料
loadEffectsData();

// 拖曳上傳
uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadFile(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        uploadFile(e.target.files[0]);
    }
});

// 上傳檔案
async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('{{ url_for("upload") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            currentFilename = data.filename;
            originalImage.src = data.url;
            uploadSection.style.display = 'none';
            resultSection.style.display = 'block';

            // 預設顯示原始影像
            selectEffect('original');
        } else {
            alert(data.error || '上傳失敗');
        }
    } catch (error) {
        alert('上傳失敗: ' + error.message);
    }
}

// 從完整說明中提取簡短摘要（取第一句或前50字）
function extractSummary(text) {
    if (!text) return '';
    // 取第一行或第一句
    const firstLine = text.split('\n')[0];
    const firstSentence = firstLine.split('。')[0];
    if (firstSentence.length <= 50) {
        return firstSentence + (firstLine.includes('。') ? '' : '');
    }
    return firstSentence.substring(0, 47) + '...';
}

// 選擇效果（更新UI和參數）
function selectEffect(effect) {
    currentEffect = effect;

    // 更新按鈕狀態
    opencvBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.effect === effect);
    });

    // 更新說明
    const effectInfo = effectsData[effect];
    if (effectInfo) {
        const fullDesc = effectInfo.description || '無說明';

        // 更新簡化說明區
        descTitle.textContent = effectInfo.name;
        descSummary.textContent = extractSummary(fullDesc);

        // 更新 Modal 內容
        modalDescTitle.textContent = effectInfo.name;
        modalDescText.textContent = fullDesc;

        // 渲染參數控制
        renderParams(effectInfo.params || []);
    }

    // 自動套用效果
    processImage();
}

// 渲染參數控制項
function renderParams(params) {
    if (!params || params.length === 0) {
        paramsContainer.innerHTML = '<div class="no-params">此效果沒有可調整的參數</div>';
        currentParams = {};
        return;
    }

    let html = '';
    currentParams = {};

    params.forEach(param => {
        const paramId = `param_${param.name}`;
        currentParams[param.name] = param.default;

        html += `<div class="param-group">`;

        if (param.type === 'slider') {
            const step = param.step || 1;
            const isFloat = step < 1;
            html += `
                <div class="param-label">
                    <span>${param.label}</span>
                    <span class="param-value" id="${paramId}_value">${param.default}</span>
                </div>
                <input type="range" class="form-range" id="${paramId}"
                    min="${param.min}" max="${param.max}" step="${step}" value="${param.default}"
                    data-param="${param.name}" data-type="slider" data-float="${isFloat}">
            `;
        } else if (param.type === 'select') {
            html += `
                <div class="param-label">
                    <span>${param.label}</span>
                </div>
                <select class="form-select form-select-sm" id="${paramId}"
                    data-param="${param.name}" data-type="select">
            `;
            param.options.forEach(opt => {
                const selected = opt.value === param.default ? 'selected' : '';
                html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
            });
            html += '</select>';
        } else if (param.type === 'checkbox') {
            const checked = param.default ? 'checked' : '';
            html += `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="${paramId}"
                        data-param="${param.name}" data-type="checkbox" ${checked}>
                    <label class="form-check-label" for="${paramId}">${param.label}</label>
                </div>
            `;
        }

        html += '</div>';
    });

    paramsContainer.innerHTML = html;

    // 綁定事件
    params.forEach(param => {
        const paramId = `param_${param.name}`;
        const element = document.getElementById(paramId);

        if (param.type === 'slider') {
            const valueDisplay = document.getElementById(`${paramId}_value`);
            element.addEventListener('input', (e) => {
                const isFloat = e.target.dataset.float === 'true';
                const value = isFloat ? parseFloat(e.target.value) : parseInt(e.target.value);
                valueDisplay.textContent = value;
                currentParams[param.name] = value;
            });
        } else if (param.type === 'select') {
            element.addEventListener('change', (e) => {
                currentParams[param.name] = e.target.value;
            });
        } else if (param.type === 'checkbox') {
            element.addEventListener('change', (e) => {
                currentParams[param.name] = e.target.checked;
            });
        }
    });
}

// 收集目前參數值
function collectParams() {
    const params = {};
    const inputs = paramsContainer.querySelectorAll('[data-param]');

    inputs.forEach(input => {
        const paramName = input.dataset.param;
        const paramType = input.dataset.type;

        if (paramType === 'slider') {
            const isFloat = input.dataset.float === 'true';
            params[paramName] = isFloat ? parseFloat(input.value) : parseInt(input.value);
        } else if (paramType === 'select') {
            params[paramName] = input.value;
        } else if (paramType === 'checkbox') {
            params[paramName] = input.checked;
        }
    });

    return params;
}

// 處理影像
async function processImage() {
    if (!currentFilename) return;

    loadingSpinner.classList.add('show');

    const params = collectParams();

    try {
        const response = await fetch('{{ url_for("process") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filename: currentFilename,
                effect: currentEffect,
                params: params
            })
        });

        const data = await response.json();

        if (data.success) {
            resultImage.src = data.image;
            codeBlock.textContent = data.code;
            hljs.highlightElement(codeBlock);
        } else {
            alert(data.error || '處理失敗');
        }
    } catch (error) {
        alert('處理失敗: ' + error.message);
    } finally {
        loadingSpinner.classList.remove('show');
    }
}

// OpenCV 效果按鈕點擊
opencvBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        selectEffect(btn.dataset.effect);
    });
});

// 套用按鈕點擊
applyBtn.addEventListener('click', () => {
    processImage();
});

// 複製程式碼
copyCodeBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
        copyCodeBtn.textContent = '已複製!';
        setTimeout(() => {
            copyCodeBtn.textContent = '複製';
        }, 2000);
    });
});

// 重設
resetBtn.addEventListener('click', () => {
    currentFilename = null;
    currentEffect = 'original';
    currentParams = {};
    uploadSection.style.display = 'block';
    resultSection.style.display = 'none';
    fileInput.value = '';

    opencvBtns.forEach(btn => btn.classList.remove('active'));
});

// ===== 像素顏色顯示器 =====
const pixelCanvas = document.getElementById('pixelCanvas');
const pixelCtx = pixelCanvas.getContext('2d');
const pixelInfoBox = document.getElementById('pixelInfoBox');
const colorPreview = document.getElementById('colorPreview');
const pixelX = document.getElementById('pixelX');
const pixelY = document.getElementById('pixelY');
const pixelValuesDisplay = document.getElementById('pixelValuesDisplay');
const extraChannelInfo = document.getElementById('extraChannelInfo');

// 當結果圖片載入時，繪製到 canvas
resultImage.addEventListener('load', () => {
    pixelCanvas.width = resultImage.naturalWidth;
    pixelCanvas.height = resultImage.naturalHeight;
    pixelCtx.drawImage(resultImage, 0, 0);
    pixelInfoBox.style.display = 'block';
});

// 取得目前色彩空間參數
function getCurrentColorSpace() {
    if (currentEffect === 'color_space') {
        return currentParams.space || 'hsv_h';
    }
    return null;
}

// 根據色彩空間格式化像素值顯示
function formatPixelValues(r, g, b) {
    const space = getCurrentColorSpace();

    // 預設顯示 RGB
    let mainLabel = 'RGB';
    let mainValues = `(${r}, ${g}, ${b})`;
    let extraInfo = '';

    if (currentEffect === 'gray' || space === 'gray') {
        // 灰階
        mainLabel = '灰階值';
        mainValues = `${r}`;
    } else if (space && space.startsWith('hsv')) {
        // HSV 系列
        mainLabel = space === 'hsv' ? 'HSV' : space.toUpperCase().replace('_', ' ');
        if (space === 'hsv') {
            mainValues = `(${r}, ${g}, ${b})`;
            extraInfo = 'H: 色相, S: 飽和度, V: 明度';
        } else if (space === 'hsv_h') {
            mainLabel = 'H (色相)';
            mainValues = `${r}`;
            extraInfo = '範圍: 0-180 (OpenCV)';
        } else if (space === 'hsv_s') {
            mainLabel = 'S (飽和度)';
            mainValues = `${r}`;
            extraInfo = '範圍: 0-255';
        } else if (space === 'hsv_v') {
            mainLabel = 'V (明度)';
            mainValues = `${r}`;
            extraInfo = '範圍: 0-255';
        }
    } else if (space && space.startsWith('hls')) {
        // HLS 系列
        mainLabel = space === 'hls' ? 'HLS' : space.toUpperCase().replace('_', ' ');
        if (space === 'hls') {
            mainValues = `(${r}, ${g}, ${b})`;
            extraInfo = 'H: 色相, L: 亮度, S: 飽和度';
        } else if (space === 'hls_h') {
            mainLabel = 'H (色相)';
            mainValues = `${r}`;
        } else if (space === 'hls_l') {
            mainLabel = 'L (亮度)';
            mainValues = `${r}`;
        } else if (space === 'hls_s') {
            mainLabel = 'S (飽和度)';
            mainValues = `${r}`;
        }
    } else if (space && space.startsWith('lab')) {
        // LAB 系列
        mainLabel = space === 'lab' ? 'LAB' : space.toUpperCase().replace('_', ' ');
        if (space === 'lab') {
            mainValues = `(${r}, ${g}, ${b})`;
            extraInfo = 'L: 亮度, A: 綠紅, B: 藍黃';
        } else if (space === 'lab_l') {
            mainLabel = 'L (亮度)';
            mainValues = `${r}`;
        } else if (space === 'lab_a') {
            mainLabel = 'A (綠-紅)';
            mainValues = `${r}`;
            extraInfo = '128=中性, <128=綠, >128=紅';
        } else if (space === 'lab_b') {
            mainLabel = 'B (藍-黃)';
            mainValues = `${r}`;
            extraInfo = '128=中性, <128=藍, >128=黃';
        }
    } else if (space && space.startsWith('ycrcb')) {
        // YCrCb 系列
        mainLabel = space === 'ycrcb' ? 'YCrCb' : space.toUpperCase().replace('_', ' ');
        if (space === 'ycrcb') {
            mainValues = `(${r}, ${g}, ${b})`;
            extraInfo = 'Y: 亮度, Cr: 紅色差, Cb: 藍色差';
        } else if (space === 'ycrcb_y') {
            mainLabel = 'Y (亮度)';
            mainValues = `${r}`;
        } else if (space === 'ycrcb_cr') {
            mainLabel = 'Cr (紅色差)';
            mainValues = `${r}`;
        } else if (space === 'ycrcb_cb') {
            mainLabel = 'Cb (藍色差)';
            mainValues = `${r}`;
        }
    } else if (space === 'rgb') {
        mainLabel = 'RGB';
        mainValues = `(${r}, ${g}, ${b})`;
        extraInfo = '已從 BGR 轉換為 RGB';
    }

    return { mainLabel, mainValues, extraInfo };
}

// 滑鼠移動時讀取像素顏色
resultImage.addEventListener('mousemove', (e) => {
    const rect = resultImage.getBoundingClientRect();
    const scaleX = resultImage.naturalWidth / rect.width;
    const scaleY = resultImage.naturalHeight / rect.height;

    const x = Math.floor((e.clientX - rect.left) * scaleX);
    const y = Math.floor((e.clientY - rect.top) * scaleY);

    if (x >= 0 && x < pixelCanvas.width && y >= 0 && y < pixelCanvas.height) {
        const pixel = pixelCtx.getImageData(x, y, 1, 1).data;
        const r = pixel[0], g = pixel[1], b = pixel[2];

        // 更新座標
        pixelX.textContent = x;
        pixelY.textContent = y;

        // 取得格式化的像素值
        const { mainLabel, mainValues, extraInfo } = formatPixelValues(r, g, b);

        // 更新顏色預覽
        colorPreview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;

        // 更新主要數值顯示
        pixelValuesDisplay.innerHTML = `<small>${mainLabel}: ${mainValues}</small>`;

        // 更新額外資訊
        if (extraInfo) {
            extraChannelInfo.innerHTML = `<small>${extraInfo}</small>`;
        } else {
            extraChannelInfo.innerHTML = '';
        }
    }
});

resultImage.addEventListener('mouseleave', () => {
    pixelX.textContent = '-';
    pixelY.textContent = '-';
    pixelValuesDisplay.innerHTML = '<small>RGB: (-, -, -)</small>';
    colorPreview.style.backgroundColor = '#ccc';
    extraChannelInfo.innerHTML = '';
});

// ========================================
// ===== NumPy 相關函數 =====
// ========================================

// 載入 NumPy 效果資料
async function loadNumpyEffectsData() {
    try {
        const response = await fetch('{{ url_for("numpy_effects") }}');
        numpyEffectsData = await response.json();
        // 自動選擇第一個效果
        selectNumpyEffect('array_create');
    } catch (error) {
        console.error('載入 NumPy 效果資料失敗:', error);
    }
}

// 選擇 NumPy 效果
function selectNumpyEffect(effect) {
    currentNumpyEffect = effect;

    // 更新按鈕狀態
    numpyBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.effect === effect);
    });

    // 更新說明
    const effectInfo = numpyEffectsData[effect];
    if (effectInfo) {
        const fullDesc = effectInfo.description || '無說明';

        // 更新簡化說明區
        numpyDescTitle.textContent = effectInfo.name;
        numpyDescSummary.textContent = extractSummary(fullDesc);

        // 更新 Modal 內容
        numpyModalDescTitle.textContent = effectInfo.name;
        numpyModalDescText.textContent = fullDesc;

        // 檢查是否需要圖片
        const requiresImage = effectInfo.requires_image || false;
        sourceToggle.style.display = requiresImage ? 'block' : 'none';

        if (requiresImage) {
            const source = document.querySelector('input[name="numpySource"]:checked').value;
            numpyUploadSection.style.display = (source === 'image' && !numpyFilename) ? 'block' : 'none';
        } else {
            numpyUploadSection.style.display = 'none';
        }

        // 渲染參數控制
        renderNumpyParams(effectInfo.params || []);
    }

    // 執行操作
    processNumpyOperation();
}

// 渲染 NumPy 參數控制項
function renderNumpyParams(params) {
    if (!params || params.length === 0) {
        numpyParamsContainer.innerHTML = '<div class="no-params">此操作沒有可調整的參數</div>';
        currentNumpyParams = {};
        return;
    }

    let html = '';
    currentNumpyParams = {};

    params.forEach(param => {
        const paramId = `numpy_param_${param.name}`;
        currentNumpyParams[param.name] = param.default;

        html += `<div class="param-group">`;

        if (param.type === 'slider') {
            const step = param.step || 1;
            const isFloat = step < 1;
            html += `
                <div class="param-label">
                    <span>${param.label}</span>
                    <span class="param-value" id="${paramId}_value">${param.default}</span>
                </div>
                <input type="range" class="form-range" id="${paramId}"
                    min="${param.min}" max="${param.max}" step="${step}" value="${param.default}"
                    data-param="${param.name}" data-type="slider" data-float="${isFloat}">
            `;
        } else if (param.type === 'select') {
            html += `
                <div class="param-label">
                    <span>${param.label}</span>
                </div>
                <select class="form-select form-select-sm" id="${paramId}"
                    data-param="${param.name}" data-type="select">
            `;
            param.options.forEach(opt => {
                const selected = opt.value === param.default ? 'selected' : '';
                html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
            });
            html += '</select>';
        } else if (param.type === 'checkbox') {
            const checked = param.default ? 'checked' : '';
            html += `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="${paramId}"
                        data-param="${param.name}" data-type="checkbox" ${checked}>
                    <label class="form-check-label" for="${paramId}">${param.label}</label>
                </div>
            `;
        }

        html += '</div>';
    });

    numpyParamsContainer.innerHTML = html;

    // 綁定事件
    params.forEach(param => {
        const paramId = `numpy_param_${param.name}`;
        const element = document.getElementById(paramId);

        if (param.type === 'slider') {
            const valueDisplay = document.getElementById(`${paramId}_value`);
            element.addEventListener('input', (e) => {
                const isFloat = e.target.dataset.float === 'true';
                const value = isFloat ? parseFloat(e.target.value) : parseInt(e.target.value);
                valueDisplay.textContent = value;
                currentNumpyParams[param.name] = value;
            });
        } else if (param.type === 'select') {
            element.addEventListener('change', (e) => {
                currentNumpyParams[param.name] = e.target.value;
            });
        } else if (param.type === 'checkbox') {
            element.addEventListener('change', (e) => {
                currentNumpyParams[param.name] = e.target.checked;
            });
        }
    });
}

// 收集 NumPy 參數
function collectNumpyParams() {
    const params = {};
    const inputs = numpyParamsContainer.querySelectorAll('[data-param]');

    inputs.forEach(input => {
        const paramName = input.dataset.param;
        const paramType = input.dataset.type;

        if (paramType === 'slider') {
            const isFloat = input.dataset.float === 'true';
            params[paramName] = isFloat ? parseFloat(input.value) : parseInt(input.value);
        } else if (paramType === 'select') {
            params[paramName] = input.value;
        } else if (paramType === 'checkbox') {
            params[paramName] = input.checked;
        }
    });

    return params;
}

// 處理 NumPy 操作
async function processNumpyOperation() {
    const params = collectNumpyParams();
    const effectInfo = numpyEffectsData[currentNumpyEffect];
    const requiresImage = effectInfo?.requires_image || false;
    const source = document.querySelector('input[name="numpySource"]:checked')?.value || 'sample';

    // 需要圖片但沒有上傳
    if (requiresImage && source === 'image' && !numpyFilename) {
        inputArrayDisplay.innerHTML = '<div class="text-muted">請先上傳圖片</div>';
        outputArrayDisplay.innerHTML = '<div class="text-muted">請先上傳圖片</div>';
        return;
    }

    try {
        const response = await fetch('{{ url_for("process_numpy") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                effect: currentNumpyEffect,
                params: params,
                source: requiresImage ? source : 'sample',
                filename: numpyFilename
            })
        });

        const data = await response.json();

        if (data.success) {
            // 更新程式碼
            numpyCodeBlock.textContent = data.code;
            hljs.highlightElement(numpyCodeBlock);

            // 渲染輸入
            renderNumpyInput(data);

            // 渲染輸出
            renderNumpyOutput(data);
        } else {
            alert(data.error || '處理失敗');
        }
    } catch (error) {
        console.error('NumPy 處理失敗:', error);
    }
}

// 渲染 NumPy 輸入
function renderNumpyInput(data) {
    if (data.input_image) {
        inputArrayDisplay.innerHTML = `<img src="${data.input_image}" style="max-width: 100%; max-height: 200px;">`;
        inputArrayInfo.textContent = '';
    } else if (data.input_array) {
        const arr = data.input_array;
        inputArrayDisplay.innerHTML = renderArrayGrid(arr.data, data.extra_info?.highlight);
        inputArrayInfo.textContent = `shape: (${arr.shape.join(', ')})  dtype: ${arr.dtype}`;
    } else if (data.input_arrays && data.input_arrays.length > 0) {
        let html = '<div class="arrays-comparison">';
        data.input_arrays.forEach((arr, i) => {
            html += `<div>
                <div class="array-label">${i === 0 ? 'A' : 'B'}</div>
                ${renderArrayGrid(arr.data)}
                <div class="array-info">shape: (${arr.shape.join(', ')})</div>
            </div>`;
            if (i < data.input_arrays.length - 1) {
                const symbol = data.extra_info?.operation_symbol || '+';
                html += `<div class="array-arrow">${symbol}</div>`;
            }
        });
        html += '</div>';
        inputArrayDisplay.innerHTML = html;
        inputArrayInfo.textContent = '';
    } else {
        inputArrayDisplay.innerHTML = '<div class="text-muted">無輸入陣列</div>';
        inputArrayInfo.textContent = '';
    }
}

// 渲染 NumPy 輸出
function renderNumpyOutput(data) {
    if (data.output_image) {
        outputArrayDisplay.innerHTML = `<img src="${data.output_image}" style="max-width: 100%; max-height: 200px;">`;
        outputArrayInfo.textContent = '';
    } else if (data.output_array) {
        const arr = data.output_array;
        outputArrayDisplay.innerHTML = renderArrayGrid(arr.data, data.extra_info?.highlight);
        outputArrayInfo.textContent = `shape: (${arr.shape.join(', ')})  dtype: ${arr.dtype}`;
    } else if (data.output_scalar !== undefined) {
        outputArrayDisplay.innerHTML = `<div class="scalar-result">${data.output_scalar}</div>`;
        outputArrayInfo.textContent = '純量結果';
    } else if (data.output_list) {
        if (Array.isArray(data.output_list[0])) {
            // 多個陣列
            let html = '<div class="arrays-comparison" style="flex-direction: column; gap: 10px;">';
            data.output_list.forEach((arr, i) => {
                html += `<div>
                    <div class="array-label">部分 ${i + 1}</div>
                    ${renderArrayGrid(arr)}
                </div>`;
            });
            html += '</div>';
            outputArrayDisplay.innerHTML = html;
        } else {
            // 1D 結果
            outputArrayDisplay.innerHTML = renderArrayGrid([data.output_list]);
        }
        outputArrayInfo.textContent = '';
    } else if (data.output_dict) {
        let html = '<div class="list-result">';
        for (const [key, value] of Object.entries(data.output_dict)) {
            html += `<div><strong>${key}:</strong> [${Array.isArray(value) ? value.join(', ') : value}]</div>`;
        }
        html += '</div>';
        outputArrayDisplay.innerHTML = html;
        outputArrayInfo.textContent = '';
    } else {
        outputArrayDisplay.innerHTML = '<div class="text-muted">無輸出</div>';
        outputArrayInfo.textContent = '';
    }
}

// 渲染陣列格子圖
function renderArrayGrid(data, highlights = []) {
    if (!data || data.length === 0) return '<div class="text-muted">空陣列</div>';

    // 確保是 2D
    let arr2d = data;
    if (!Array.isArray(data[0])) {
        arr2d = [data];  // 1D → 2D
    }

    // 找出最大最小值來做顏色映射
    let allValues = arr2d.flat();
    let numericValues = allValues.filter(v => typeof v === 'number' && !isNaN(v));
    let minVal = Math.min(...numericValues);
    let maxVal = Math.max(...numericValues);

    // 高亮位置的集合
    const highlightSet = new Set(highlights.map(([r, c]) => `${r},${c}`));

    let html = '<div class="array-grid">';
    arr2d.forEach((row, i) => {
        html += '<div class="array-row">';
        row.forEach((cell, j) => {
            // 計算背景顏色（熱力圖效果）
            let bgColor = '#f8f9fa';
            if (typeof cell === 'number' && !isNaN(cell) && maxVal !== minVal) {
                const ratio = (cell - minVal) / (maxVal - minVal);
                const hue = (1 - ratio) * 240;  // 藍 → 紅
                bgColor = `hsl(${hue}, 70%, 80%)`;
            }

            // 檢查是否高亮
            const isHighlight = highlightSet.has(`${i},${j}`);
            const highlightClass = isHighlight ? 'highlight selected' : '';

            // 格式化數值
            let displayVal = cell;
            if (typeof cell === 'number') {
                if (Number.isInteger(cell)) {
                    displayVal = cell;
                } else {
                    displayVal = cell.toFixed(2);
                }
            }

            html += `<div class="array-cell ${highlightClass}" style="background: ${bgColor};">${displayVal}</div>`;
        });
        html += '</div>';
    });
    html += '</div>';

    return html;
}

// NumPy 效果按鈕點擊
numpyBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        selectNumpyEffect(btn.dataset.effect);
    });
});

// NumPy 套用按鈕
numpyApplyBtn.addEventListener('click', () => {
    processNumpyOperation();
});

// NumPy 複製程式碼
copyNumpyCodeBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(numpyCodeBlock.textContent).then(() => {
        copyNumpyCodeBtn.textContent = '已複製!';
        setTimeout(() => {
            copyNumpyCodeBtn.textContent = '複製';
        }, 2000);
    });
});

// NumPy 圖片上傳
numpyUploadZone.addEventListener('click', () => numpyFileInput.click());

numpyUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    numpyUploadZone.classList.add('dragover');
});

numpyUploadZone.addEventListener('dragleave', () => {
    numpyUploadZone.classList.remove('dragover');
});

numpyUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    numpyUploadZone.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        uploadNumpyFile(e.dataTransfer.files[0]);
    }
});

numpyFileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        uploadNumpyFile(e.target.files[0]);
    }
});

async function uploadNumpyFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('{{ url_for("upload") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            numpyFilename = data.filename;
            numpyUploadSection.style.display = 'none';
            processNumpyOperation();
        } else {
            alert(data.error || '上傳失敗');
        }
    } catch (error) {
        alert('上傳失敗: ' + error.message);
    }
}

// 來源切換
document.querySelectorAll('input[name="numpySource"]').forEach(radio => {
    radio.addEventListener('change', (e) => {
        const requiresImage = numpyEffectsData[currentNumpyEffect]?.requires_image;
        if (requiresImage) {
            if (e.target.value === 'image' && !numpyFilename) {
                numpyUploadSection.style.display = 'block';
            } else {
                numpyUploadSection.style.display = 'none';
                processNumpyOperation();
            }
        }
    });
});

// 初始化 highlight.js
hljs.highlightAll();
</script>
{% endblock %}
