{% extends "base.html" %}

{% block title %}操作頁面 - OpenCV 教學平台{% endblock %}

{% block extra_head %}
<style>
    .sidebar {
        height: calc(100vh - 56px);
        overflow-y: auto;
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
    }
    .main-content {
        height: calc(100vh - 56px);
        overflow-y: auto;
    }
    .effect-btn {
        text-align: left;
        border: none;
        background: none;
        padding: 8px 16px;
        width: 100%;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 0.9rem;
    }
    .effect-btn:hover {
        background: #e9ecef;
    }
    .effect-btn.active {
        background: #0dcaf0;
        color: white;
    }
    .category-header {
        font-weight: bold;
        padding: 10px 16px;
        background: #dee2e6;
        margin-top: 10px;
        font-size: 0.85rem;
    }
    .category-header:first-child {
        margin-top: 0;
    }
    .image-container {
        min-height: 250px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f0f0f0;
        border-radius: 8px;
    }
    .image-container img {
        max-width: 100%;
        max-height: 400px;
        object-fit: contain;
    }
    .code-container {
        max-height: 300px;
        overflow-y: auto;
    }
    .upload-zone {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    .upload-zone:hover {
        border-color: #0dcaf0;
        background: #f8f9fa;
    }
    .upload-zone.dragover {
        border-color: #0dcaf0;
        background: #e0f7fa;
    }
    .loading {
        display: none;
    }
    .loading.show {
        display: block;
    }
    pre code {
        font-size: 0.8rem;
    }
    /* 說明區塊 */
    .description-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
    }
    .description-box h5 {
        margin-bottom: 10px;
        font-weight: bold;
    }
    .description-box p {
        margin-bottom: 0;
        font-size: 0.95rem;
        line-height: 1.6;
    }
    /* 參數控制區 */
    .params-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 10px;
        padding: 15px 20px;
        margin-bottom: 15px;
    }
    .params-box h6 {
        color: #856404;
        margin-bottom: 15px;
        font-weight: bold;
    }
    .param-group {
        margin-bottom: 15px;
    }
    .param-group:last-child {
        margin-bottom: 0;
    }
    .param-label {
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .param-value {
        color: #0d6efd;
        font-weight: bold;
        font-size: 0.9rem;
    }
    .form-range {
        width: 100%;
    }
    .form-select, .form-check-input {
        cursor: pointer;
    }
    .no-params {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        padding: 10px;
    }
    /* 套用按鈕 */
    .apply-btn {
        width: 100%;
        padding: 10px;
        font-weight: bold;
    }
    /* 像素顏色顯示器 */
    .pixel-info-box {
        background: #2d3748;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-family: monospace;
    }
    .color-preview {
        width: 40px;
        height: 40px;
        border-radius: 6px;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .pixel-values {
        flex: 1;
    }
    .pixel-values small {
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- 左側選單 -->
        <div class="col-md-3 col-lg-2 p-0 sidebar">
            {% for category, effects in categories.items() %}
            <div class="category-header">{{ category }}</div>
            {% for effect in effects %}
            <button class="effect-btn" data-effect="{{ effect.id }}">
                {{ effect.name }}
            </button>
            {% endfor %}
            {% endfor %}
        </div>

        <!-- 主要內容區 -->
        <div class="col-md-9 col-lg-10 main-content p-4">
            <!-- 上傳區域 -->
            <div id="uploadSection" class="mb-4">
                <div class="upload-zone" id="uploadZone">
                    <div class="mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="currentColor" class="text-muted" viewBox="0 0 16 16">
                            <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                            <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
                        </svg>
                    </div>
                    <h4>拖曳圖片到這裡</h4>
                    <p class="text-muted mb-2">或點擊選擇檔案</p>
                    <p class="text-muted small">支援 PNG, JPG, GIF, BMP, WebP (最大 16MB)</p>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;">
                </div>
            </div>

            <!-- 結果區域 -->
            <div id="resultSection" style="display: none;">
                <!-- 說明區塊 -->
                <div class="description-box" id="descriptionBox">
                    <h5 id="descTitle">原始影像</h5>
                    <p id="descText">顯示原始上傳的影像，不做任何處理。</p>
                </div>

                <div class="row">
                    <!-- 左側：圖片顯示 -->
                    <div class="col-lg-8">
                        <div class="row">
                            <!-- 原圖 -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white py-2">
                                        <h6 class="mb-0 small">原始影像</h6>
                                    </div>
                                    <div class="card-body image-container p-2">
                                        <img id="originalImage" src="" alt="原始影像">
                                    </div>
                                </div>
                            </div>

                            <!-- 處理後 -->
                            <div class="col-md-6 mb-3">
                                <div class="card">
                                    <div class="card-header bg-info text-white py-2 d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 small">處理結果</h6>
                                        <div class="spinner-border spinner-border-sm text-light loading" id="loadingSpinner" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                    <div class="card-body image-container p-2" style="position: relative;">
                                        <img id="resultImage" src="" alt="處理結果" style="cursor: crosshair;">
                                        <canvas id="pixelCanvas" style="display: none;"></canvas>
                                    </div>
                                </div>
                                <!-- 像素顏色顯示器 -->
                                <div class="pixel-info-box mt-2" id="pixelInfoBox" style="display: none;">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="color-preview" id="colorPreview"></div>
                                        <div class="pixel-values">
                                            <div><small>座標: (<span id="pixelX">-</span>, <span id="pixelY">-</span>)</small></div>
                                            <div><small>RGB: (<span id="pixelR">-</span>, <span id="pixelG">-</span>, <span id="pixelB">-</span>)</small></div>
                                            <div id="extraChannelInfo"><small></small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 程式碼區域 -->
                        <div class="card mb-3">
                            <div class="card-header bg-dark text-white py-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 small">Python 程式碼</h6>
                                <button class="btn btn-sm btn-outline-light py-0" id="copyCodeBtn">複製</button>
                            </div>
                            <div class="card-body code-container p-0">
                                <pre class="m-0"><code id="codeBlock" class="python"></code></pre>
                            </div>
                        </div>
                    </div>

                    <!-- 右側：參數控制 -->
                    <div class="col-lg-4">
                        <div class="params-box">
                            <h6>參數調整</h6>
                            <div id="paramsContainer">
                                <div class="no-params">此效果沒有可調整的參數</div>
                            </div>
                            <hr class="my-3">
                            <button class="btn btn-warning apply-btn" id="applyBtn">
                                套用效果
                            </button>
                        </div>

                        <!-- 重新上傳 -->
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-secondary btn-sm" id="resetBtn">
                                上傳新圖片
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// 效果資料（從後端載入）
let effectsData = {};
let currentFilename = null;
let currentEffect = 'original';
let currentParams = {};

const uploadZone = document.getElementById('uploadZone');
const fileInput = document.getElementById('fileInput');
const uploadSection = document.getElementById('uploadSection');
const resultSection = document.getElementById('resultSection');
const originalImage = document.getElementById('originalImage');
const resultImage = document.getElementById('resultImage');
const descTitle = document.getElementById('descTitle');
const descText = document.getElementById('descText');
const codeBlock = document.getElementById('codeBlock');
const loadingSpinner = document.getElementById('loadingSpinner');
const paramsContainer = document.getElementById('paramsContainer');
const effectBtns = document.querySelectorAll('.effect-btn');
const copyCodeBtn = document.getElementById('copyCodeBtn');
const resetBtn = document.getElementById('resetBtn');
const applyBtn = document.getElementById('applyBtn');

// 載入效果資料
async function loadEffectsData() {
    try {
        const response = await fetch('{{ url_for("effects") }}');
        effectsData = await response.json();
    } catch (error) {
        console.error('載入效果資料失敗:', error);
    }
}

// 初始化時載入效果資料
loadEffectsData();

// 拖曳上傳
uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        uploadFile(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        uploadFile(e.target.files[0]);
    }
});

// 上傳檔案
async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('{{ url_for("upload") }}', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            currentFilename = data.filename;
            originalImage.src = data.url;
            uploadSection.style.display = 'none';
            resultSection.style.display = 'block';

            // 預設顯示原始影像
            selectEffect('original');
        } else {
            alert(data.error || '上傳失敗');
        }
    } catch (error) {
        alert('上傳失敗: ' + error.message);
    }
}

// 選擇效果（更新UI和參數）
function selectEffect(effect) {
    currentEffect = effect;

    // 更新按鈕狀態
    effectBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.effect === effect);
    });

    // 更新說明
    const effectInfo = effectsData[effect];
    if (effectInfo) {
        descTitle.textContent = effectInfo.name;
        descText.textContent = effectInfo.description || '無說明';

        // 渲染參數控制
        renderParams(effectInfo.params || []);
    }

    // 自動套用效果
    processImage();
}

// 渲染參數控制項
function renderParams(params) {
    if (!params || params.length === 0) {
        paramsContainer.innerHTML = '<div class="no-params">此效果沒有可調整的參數</div>';
        currentParams = {};
        return;
    }

    let html = '';
    currentParams = {};

    params.forEach(param => {
        const paramId = `param_${param.name}`;
        currentParams[param.name] = param.default;

        html += `<div class="param-group">`;

        if (param.type === 'slider') {
            const step = param.step || 1;
            const isFloat = step < 1;
            html += `
                <div class="param-label">
                    <span>${param.label}</span>
                    <span class="param-value" id="${paramId}_value">${param.default}</span>
                </div>
                <input type="range" class="form-range" id="${paramId}"
                    min="${param.min}" max="${param.max}" step="${step}" value="${param.default}"
                    data-param="${param.name}" data-type="slider" data-float="${isFloat}">
            `;
        } else if (param.type === 'select') {
            html += `
                <div class="param-label">
                    <span>${param.label}</span>
                </div>
                <select class="form-select form-select-sm" id="${paramId}"
                    data-param="${param.name}" data-type="select">
            `;
            param.options.forEach(opt => {
                const selected = opt.value === param.default ? 'selected' : '';
                html += `<option value="${opt.value}" ${selected}>${opt.label}</option>`;
            });
            html += '</select>';
        } else if (param.type === 'checkbox') {
            const checked = param.default ? 'checked' : '';
            html += `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="${paramId}"
                        data-param="${param.name}" data-type="checkbox" ${checked}>
                    <label class="form-check-label" for="${paramId}">${param.label}</label>
                </div>
            `;
        }

        html += '</div>';
    });

    paramsContainer.innerHTML = html;

    // 綁定事件
    params.forEach(param => {
        const paramId = `param_${param.name}`;
        const element = document.getElementById(paramId);

        if (param.type === 'slider') {
            const valueDisplay = document.getElementById(`${paramId}_value`);
            element.addEventListener('input', (e) => {
                const isFloat = e.target.dataset.float === 'true';
                const value = isFloat ? parseFloat(e.target.value) : parseInt(e.target.value);
                valueDisplay.textContent = value;
                currentParams[param.name] = value;
            });
        } else if (param.type === 'select') {
            element.addEventListener('change', (e) => {
                currentParams[param.name] = e.target.value;
            });
        } else if (param.type === 'checkbox') {
            element.addEventListener('change', (e) => {
                currentParams[param.name] = e.target.checked;
            });
        }
    });
}

// 收集目前參數值
function collectParams() {
    const params = {};
    const inputs = paramsContainer.querySelectorAll('[data-param]');

    inputs.forEach(input => {
        const paramName = input.dataset.param;
        const paramType = input.dataset.type;

        if (paramType === 'slider') {
            const isFloat = input.dataset.float === 'true';
            params[paramName] = isFloat ? parseFloat(input.value) : parseInt(input.value);
        } else if (paramType === 'select') {
            params[paramName] = input.value;
        } else if (paramType === 'checkbox') {
            params[paramName] = input.checked;
        }
    });

    return params;
}

// 處理影像
async function processImage() {
    if (!currentFilename) return;

    loadingSpinner.classList.add('show');

    const params = collectParams();

    try {
        const response = await fetch('{{ url_for("process") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filename: currentFilename,
                effect: currentEffect,
                params: params
            })
        });

        const data = await response.json();

        if (data.success) {
            resultImage.src = data.image;
            codeBlock.textContent = data.code;
            hljs.highlightElement(codeBlock);
        } else {
            alert(data.error || '處理失敗');
        }
    } catch (error) {
        alert('處理失敗: ' + error.message);
    } finally {
        loadingSpinner.classList.remove('show');
    }
}

// 效果按鈕點擊
effectBtns.forEach(btn => {
    btn.addEventListener('click', () => {
        selectEffect(btn.dataset.effect);
    });
});

// 套用按鈕點擊
applyBtn.addEventListener('click', () => {
    processImage();
});

// 複製程式碼
copyCodeBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(codeBlock.textContent).then(() => {
        copyCodeBtn.textContent = '已複製!';
        setTimeout(() => {
            copyCodeBtn.textContent = '複製';
        }, 2000);
    });
});

// 重設
resetBtn.addEventListener('click', () => {
    currentFilename = null;
    currentEffect = 'original';
    currentParams = {};
    uploadSection.style.display = 'block';
    resultSection.style.display = 'none';
    fileInput.value = '';

    effectBtns.forEach(btn => btn.classList.remove('active'));
});

// ===== 像素顏色顯示器 =====
const pixelCanvas = document.getElementById('pixelCanvas');
const pixelCtx = pixelCanvas.getContext('2d');
const pixelInfoBox = document.getElementById('pixelInfoBox');
const colorPreview = document.getElementById('colorPreview');
const pixelX = document.getElementById('pixelX');
const pixelY = document.getElementById('pixelY');
const pixelR = document.getElementById('pixelR');
const pixelG = document.getElementById('pixelG');
const pixelB = document.getElementById('pixelB');
const extraChannelInfo = document.getElementById('extraChannelInfo');

// 當結果圖片載入時，繪製到 canvas
resultImage.addEventListener('load', () => {
    pixelCanvas.width = resultImage.naturalWidth;
    pixelCanvas.height = resultImage.naturalHeight;
    pixelCtx.drawImage(resultImage, 0, 0);
    pixelInfoBox.style.display = 'block';
});

// 滑鼠移動時讀取像素顏色
resultImage.addEventListener('mousemove', (e) => {
    const rect = resultImage.getBoundingClientRect();
    const scaleX = resultImage.naturalWidth / rect.width;
    const scaleY = resultImage.naturalHeight / rect.height;

    const x = Math.floor((e.clientX - rect.left) * scaleX);
    const y = Math.floor((e.clientY - rect.top) * scaleY);

    if (x >= 0 && x < pixelCanvas.width && y >= 0 && y < pixelCanvas.height) {
        const pixel = pixelCtx.getImageData(x, y, 1, 1).data;
        const r = pixel[0], g = pixel[1], b = pixel[2];

        // 更新顯示
        pixelX.textContent = x;
        pixelY.textContent = y;
        pixelR.textContent = r;
        pixelG.textContent = g;
        pixelB.textContent = b;
        colorPreview.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;

        // 根據目前效果顯示額外資訊
        let extraInfo = '';
        if (currentEffect.startsWith('hsv') || currentEffect.startsWith('hls')) {
            // 計算 HSV/HLS 值
            const max = Math.max(r, g, b) / 255;
            const min = Math.min(r, g, b) / 255;
            const d = max - min;
            let h = 0, s = 0, v = max;
            if (d > 0) {
                s = max > 0 ? d / max : 0;
                if (max === r / 255) h = ((g - b) / 255 / d) % 6;
                else if (max === g / 255) h = (b - r) / 255 / d + 2;
                else h = (r - g) / 255 / d + 4;
                h = Math.round(h * 30);  // OpenCV 用 0-180
                if (h < 0) h += 180;
            }
            s = Math.round(s * 255);
            v = Math.round(v * 255);
            extraInfo = `HSV: (${h}, ${s}, ${v})`;
        } else if (currentEffect.startsWith('lab')) {
            // 近似 LAB 值
            const l = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
            extraInfo = `灰階亮度: ${l}`;
        } else if (currentEffect.startsWith('ycrcb')) {
            // 計算 YCrCb 值
            const y_val = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
            const cr = Math.round(128 + 0.5 * r - 0.419 * g - 0.081 * b);
            const cb = Math.round(128 - 0.169 * r - 0.331 * g + 0.5 * b);
            extraInfo = `YCrCb: (${y_val}, ${cr}, ${cb})`;
        } else if (currentEffect === 'gray') {
            const gray = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
            extraInfo = `灰階值: ${gray}`;
        }

        if (extraInfo) {
            extraChannelInfo.innerHTML = `<small>${extraInfo}</small>`;
        } else {
            extraChannelInfo.innerHTML = '';
        }
    }
});

resultImage.addEventListener('mouseleave', () => {
    pixelX.textContent = '-';
    pixelY.textContent = '-';
    pixelR.textContent = '-';
    pixelG.textContent = '-';
    pixelB.textContent = '-';
    colorPreview.style.backgroundColor = '#ccc';
    extraChannelInfo.innerHTML = '';
});

// 初始化 highlight.js
hljs.highlightAll();
</script>
{% endblock %}
